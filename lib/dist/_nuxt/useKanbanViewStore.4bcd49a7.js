import{M as Se,L as ke,bF as me,aM as Ve,r as S,bb as $e,g as De,ba as _e,fV as je,X as j,Y as C,C as Fe,f8 as re}from"./entry.96205fa0.js";import{b as Ke,S as Pe}from"./index.9b87fcff.js";import{d as Ae}from"./deepCompare.d32ec333.js";import{e as F,r as Y}from"./dataUtils.fb0a3616.js";import{a as Ce,f as qe,p as Ee}from"./bases.965a49bb.js";import{a as xe,b as Ie}from"./useSmartsheetStore.7d51347e.js";import{u as Ne}from"./index.e034edbd.js";import{u as ze}from"./useSharedView.9e320acb.js";const[Xe,Je]=Ne((n,r,ce=!1)=>{var ie;if(!n)throw new Error("Table meta is not available");const{t:Z}=Se(),{api:q}=ke(),{base:w,sqlUis:M}=me(Ce()),{$e:de,$api:K}=Fe(),{sorts:z,nestedFilters:J}=xe(),{sharedView:ee,fetchSharedViewData:ve,fetchSharedViewGroupedData:fe}=ze(),{isUIAllowed:U}=Ve(),$=S(ce)||$e(Ke,S(!1)),pe=S(null),{search:E}=Ie(),{addUndo:B,clone:P,defineViewScope:G}=qe(),L=S([]),ge=S((ie=n.value)!=null&&ie.source_id?M.value[n.value.source_id]:Object.values(M.value)[0]),H=De(()=>{var l,a,o,s;let e;const t=((a=(l=n.value)==null?void 0:l.columns)==null?void 0:a.find(({id:i})=>i===E.value.field))||((s=(o=n.value)==null?void 0:o.columns)==null?void 0:s.find(i=>i.pv));if(t&&E.value.query.trim())return["text","string"].includes(ge.value.getAbstractType(t))&&t.dt!=="bigint"?e=`(${t.title},like,%${E.value.query.trim()}%)`:e=`(${t.title},eq,${E.value.query.trim()})`,e});_e(Pe,pe);const D=S({}),_=S([]),u=S(new Map),d=S(new Map),p=S(""),b=S(),h=S({}),ae=S(!1),le=e=>e.map(t=>({row:{...t},oldRow:{...t},rowMeta:{}}));async function we(){var t,l,a,o;if((!((t=w==null?void 0:w.value)!=null&&t.id)||!((l=n.value)!=null&&l.id)||!((a=r==null?void 0:r.value)!=null&&a.id)||!((o=b==null?void 0:b.value)!=null&&o.id))&&!$.value)return;u.value=new Map,d.value=new Map;let e;$.value?e=await fe(b.value.id,{sortsArr:z.value,filtersArr:J.value}):e=await q.dbViewRow.groupedDataList("noco",w.value.id,n.value.id,r.value.id,b.value.id,{where:H.value},{});for(const s of e??[]){const i=s.key;u.value.set(i,le(s.value.list)),d.value.set(i,s.value.pageInfo.totalRows||0)}}async function be(e,t={}){var o,s,i;if((!((o=w==null?void 0:w.value)!=null&&o.id)||!((s=n.value)!=null&&s.id)||!((i=r.value)!=null&&i.id))&&!$.value)return;let l=`(${p.value},eq,${e})`;e===null&&(l=`(${p.value},is,null)`),H.value&&(l=`${l} and ${H.value}`);const a=$.value?await ve({...t,sortsArr:z.value,filtersArr:J.value,offset:t.offset,where:l}):await q.dbViewRow.list("noco",w.value.id,n.value.id,r.value.id,{...t,...U("sortSync")?{}:{sortArrJson:JSON.stringify(z.value)},...U("filterSync")?{}:{filterArrJson:JSON.stringify(J.value)},where:l});u.value.set(e,[...u.value.get(e),...le(a.list)])}async function ye(){var l,a,o,s,i,f,O,k,R;if(!((l=r==null?void 0:r.value)!=null&&l.id)||!((a=n==null?void 0:n.value)!=null&&a.columns))return;D.value=$.value?(o=ee.value)==null?void 0:o.view:await K.dbView.kanbanRead(r.value.id),b.value=$.value?Ee((s=ee.value)==null?void 0:s.meta).groupingFieldColumn:n.value.columns.filter(c=>c.id===D.value.fk_grp_col_id)[0]||{},p.value=b.value.title;const{fk_grp_col_id:e,meta:t}=D.value;if(h.value=t?JSON.parse(t):{},h.value&&e&&h.value[e]){let c=!1,y=!1;for(const v of((i=b.value.colOptions)==null?void 0:i.options)??[]){const V=h.value[e].findIndex(I=>I.id===v.id);if(V!==-1){const{collapsed:I,...N}=h.value[e][V];Ae(N,v)||(h.value[e][V]={...h.value[e][V],...v},v.title!==N.title&&(u.value.set(v.title,u.value.get(N.title)),d.value.set(v.title,d.value.get(N.title)),await X(v.title)),c=!0)}else h.value[e].push({...v,collapsed:!1}),u.value.set(v.title,[]),d.value.set(v.title,0),c=!0,y=!0}const m=(O=(f=b.value)==null?void 0:f.colOptions)==null?void 0:O.options.map(({id:v})=>v),g=h.value[e].filter(({id:v})=>v!=="uncategorized"&&!m.includes(v));for(const v of g){const V=h.value[e].map(I=>I.id).indexOf(v.id);V!==-1&&(h.value[e].splice(V,1),u.value.size&&d.value.size&&u.value.has(v.title)&&(await X(v.title,!0),u.value.set(null,[...u.value.get(null)||[],...u.value.get(v.title)]),d.value.set(null,(d.value.get(null)||0)+(d.value.get(v.title)||0))),c=!0)}_.value=h.value[e],c&&(await x(),y&&(ae.value=!0))}else _.value=[...((R=(k=b.value)==null?void 0:k.colOptions)==null?void 0:R.options)??[],{id:"uncategorized",title:null,order:0,color:je.light[2]}].sort((c,y)=>c.order-y.order).map(c=>({...c,collapsed:!1})),await x()}async function x(){const{fk_grp_col_id:e}=D.value;e&&(h.value[e]=_.value,await te({meta:h.value}))}async function te(e){var t;!((t=r==null?void 0:r.value)!=null&&t.id)||!U("dataEdit")||await K.dbView.kanbanUpdate(r.value.id,e)}function Q(e){var l;const t=Y(e,(l=n==null?void 0:n.value)==null?void 0:l.columns);for(const a of u.value.values())for(const o of a)if(Object.keys(t).every(s=>t[s]===o.row[s]))return o}async function T(e,t=u.value.get(null).length,l=!1){var a,o,s,i,f;try{const O=((a=n==null?void 0:n.value)==null?void 0:a.columns).reduce((R,c)=>((!c.ai||l)&&(e==null?void 0:e[c.title])!==null&&(R[c.title]=e==null?void 0:e[c.title]),R),{}),k=await K.dbViewRow.create(re,w==null?void 0:w.value.id,(o=n.value)==null?void 0:o.id,(s=r==null?void 0:r.value)==null?void 0:s.id,O);if(!l){const R=F(k,(i=n.value)==null?void 0:i.columns);B({redo:{fn:async function(y,m){var v;const g=Y(y.row,(v=n.value)==null?void 0:v.columns);y.row={...g,...y.row},await T(y,m,!0),A(y,!0)},args:[P(e),t]},undo:{fn:async function(y){await se(y);const m=Q(k);m&&ue(m)},args:[R]},scope:G({view:r.value})})}return(f=u.value.get(null))==null||f.splice(t??0,1,{row:k,rowMeta:{},oldRow:{...k}}),k}catch(O){j.error(await C(O))}}async function W(e,t,l=!1){var a,o,s;try{const i=F(e.row,(a=n==null?void 0:n.value)==null?void 0:a.columns),f=await K.dbViewRow.update(re,w==null?void 0:w.value.id,(o=n.value)==null?void 0:o.id,(s=r==null?void 0:r.value)==null?void 0:s.id,i,{[t]:e.row[t]});if(!l){const O=L.value.find(R=>R.op==="removed"&&R.pk===i),k=L.value.find(R=>R.op==="added"&&R.pk===i);B({redo:{fn:async function(c,y){const m=await W(c,y,!0),g=Q(c.row);g&&(Object.assign(g.row,m),g.row[p.value]!==g.oldRow[p.value]&&A(g,!1,k==null?void 0:k.index),Object.assign(g.oldRow,m))},args:[P(e),t]},undo:{fn:async function(c,y){const m=await W({row:c.oldRow,oldRow:c.row,rowMeta:c.rowMeta},y,!0),g=Q(c.row);g&&(Object.assign(g.row,m),g.row[p.value]!==g.oldRow[p.value]&&A(g,!1,O==null?void 0:O.index),Object.assign(g.oldRow,m))},args:[P(e),t]},scope:G({view:r.value})}),Object.assign(e.row,f),Object.assign(e.oldRow,f)}return f}catch(i){j.error(`${Z("msg.error.rowUpdateFailed")} ${await C(i)}`)}}async function he(e){e.rowMeta.new?await T(e.row,u.value.get(e.row.title).indexOf(e)):await W(e,p.value)}async function X(e,t=!1){var l;try{const a=t?null:e;await q.dbTableRow.bulkUpdateAll("noco",w.value.id,(l=n.value)==null?void 0:l.id,{[p.value]:a},{where:`(${p.value},eq,${e})`}),u.value.has(e)&&u.value.set(e,u.value.get(e).map(o=>({...o,row:{...o.row,[p.value]:a},oldRow:{...o.oldRow,[p.value]:o.row[p.value]}})))}catch(a){j.error(await C(a))}}async function Re(e,t){var l;if(!(!((l=r==null?void 0:r.value)!=null&&l.id)||!b.value))try{await X(e,!0),u.value.set(null,[...u.value.get(null),...u.value.get(e)]),d.value.set(null,(d.value.get(null)||0)+(d.value.get(e)||0)),u.value.delete(e),d.value.delete(e);const a=b.value.colOptions.options.filter(o=>o.title!==e);b.value.colOptions.options=a,await q.dbTableColumn.update(b.value.id,{...b.value,colOptions:{options:a}}),_.value.splice(t,1),h.value[D.value.fk_grp_col_id]=_.value,await x(),de("a:kanban:delete-stack")}catch(a){j.error(await C(a))}}function Oe(e=u.value.get(null).length){return u.value.get(null).splice(e,0,{row:{},oldRow:{},rowMeta:{new:!0}}),u.value.get(null)[e]}function A(e,t,l){const a=e.row[p.value],o=e.oldRow[p.value];if(t)a&&(l!==void 0?u.value.get(a).splice(l,0,e):u.value.get(a).push(e),d.value.set(a,d.value.get(a)+1),oe());else{const s=F(e.row,n.value.columns),i=u.value.get(o).findIndex(f=>F(f.row,n.value.columns)===s);if(i!==-1)if(a!==o){d.value.set(o,d.value.get(o)-1);const f=u.value.get(o);if(f.splice(i,1),u.value.set(o,f),d.value.set(a,d.value.get(a)+1),l!==void 0){const O=u.value.get(a);O.splice(l,0,e),u.value.set(a,O)}else u.value.set(a,[...u.value.get(a),e])}else{const f=u.value.get(a);l!==void 0?(f.splice(i,1),f.splice(l,0,e)):f[i]=e,u.value.set(o,f)}}}function ue(e){const t=F(e.row,n.value.columns),l=e.row[p.value];u.value.set(l,u.value.get(l).filter(a=>F(a.row,n.value.columns)!==t)),d.value.set(l,d.value.get(l)-1)}function oe(){u.value.get(null).pop(),d.value.set(null,d.value.get(null)-1)}async function ne(e,t=!1){var l,a;try{if(t||B({redo:{fn:async function(s){await ne(s,!0)},args:[P(e)]},undo:{fn:async function(s){var f;const i=Y(s.row,(f=n.value)==null?void 0:f.columns);s.row={...i,...s.row},await T(s.row,void 0,!0),A(s,!0)},args:[P(e)]},scope:G({view:r.value})}),!e.rowMeta.new){const o=(a=(l=n==null?void 0:n.value)==null?void 0:l.columns)==null?void 0:a.filter(i=>i.pk).map(i=>e.row[i.title]).join("___");if(!await se(o))return}ue(e)}catch(o){j.error(`${Z("msg.error.deleteRowFailed")}: ${await C(o)}`)}}async function se(e){var l,a;if(!e)throw new Error("Delete not allowed for table which doesn't have primary Key");const t=await K.dbViewRow.delete("noco",w.value.id,(l=n.value)==null?void 0:l.id,(a=r.value)==null?void 0:a.id,encodeURIComponent(e));return t.message?(j.info(`Record delete failed: ${`Unable to delete record with ID ${e} because of the following:
              
${t.message.join(`
`)}.

              Clear the data first & try again`})}`),!1):!0}return{loadKanbanData:we,loadMoreKanbanData:be,loadKanbanMeta:ye,updateKanbanMeta:te,kanbanMetaData:D,formattedData:u,countByStack:d,groupingField:p,groupingFieldColOptions:_,groupingFieldColumn:b,updateOrSaveRow:he,addEmptyRow:Oe,addOrEditStackRow:A,deleteStack:Re,updateKanbanStackMeta:x,removeRowFromUncategorizedStack:oe,shouldScrollToRight:ae,deleteRow:ne,moveHistory:L}},"kanban-view-store");function Ye(){const n=Je();if(n==null)throw new Error("Please call `useProvideKanbanViewStore` on the appropriate parent component");return n}export{Ye as a,Xe as u};
