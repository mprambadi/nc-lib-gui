import{a as O,u as C,b as G,p as z}from"./bases.e6c8e3c4.js";import{S as F}from"./index.9b87fcff.js";import{r as b,$ as I,bF as V,bG as d,ba as L,g as j,eN as q,cG as n,C as B}from"./entry.5958c07b.js";function $(){const c=b([]),{appInfo:A}=I(),g=O(),J=C(),{basesUser:D}=V(J),{base:x}=V(g),h=A.value.defaultLimit||25,l=d("paginationData",()=>({page:1,pageSize:h})),r=d("sharedView",()=>{}),p=b([]),i=d("password",()=>{});L(F,i);const m=d("allowCSVDownload",()=>!1),f=d("meta",()=>{}),N=j(()=>{var a,s;return((s=(a=f.value)==null?void 0:a.columns)==null?void 0:s.filter(e=>e.show&&e.uidt!==n.Rollup&&e.uidt!==n.Lookup&&e.uidt!==n.Formula&&e.uidt!==n.Barcode&&e.uidt!==n.QrCode).sort((e,t)=>e.order-t.order).map(e=>({...e,required:!!e.required})))??[]}),{$api:v}=B(),{setMeta:y}=G();return{sharedView:r,loadSharedView:async(a,s=void 0)=>{var w,S;const e=await v.public.sharedViewMetaGet(a,{headers:{"xc-password":s??i.value}});try{m.value=(w=z(e.meta))==null?void 0:w.allowCSVDownload}catch{m.value=!1}s&&(i.value=s),r.value={title:"",...e},f.value={...e.model};let t=1;f.value.columns=[...e.model.columns].filter(o=>o.show).map(o=>({...o,order:t++})).sort((o,M)=>o.order-M.order),await y(e.model),(S=x.value)!=null&&S.sources||g.setProject({id:e.base_id,sources:[{id:e.source_id,type:e.client}]});const u={...e.relatedMetas};Object.keys(u).forEach(o=>y(u[o])),e.users&&D.value.set(e.base_id,e.users)},meta:f,nestedFilters:c,fetchSharedViewData:async a=>{var s;if(!r.value)return{list:[],pageInfo:{}};if(!a.offset){const e=l.value.page||1,t=l.value.pageSize||h;a.offset=(e-1)*t}return await v.public.dataList(r.value.uuid,{limit:((s=r.value)==null?void 0:s.type)===q.MAP?1e3:void 0,...a,filterArrJson:JSON.stringify(a.filtersArr??c.value),sortArrJson:JSON.stringify(a.sortsArr??p.value)},{headers:{"xc-password":i.value}})},fetchSharedViewGroupedData:async(a,{sortsArr:s,filtersArr:e})=>{if(!r.value)return;const t=l.value.page||1,u=l.value.pageSize||h;return await v.public.groupedDataList(r.value.uuid,a,{offset:(t-1)*u,filterArrJson:JSON.stringify(e??c.value),sortArrJson:JSON.stringify(s??p.value)},{headers:{"xc-password":i.value}})},paginationData:l,sorts:p,exportFile:async(a,s,e,t,{sortsArr:u,filtersArr:w}={sortsArr:[],filtersArr:[]})=>await v.public.csvExport(r.value.uuid,e,{format:t,query:{fields:a.map(S=>S.title),offset:s,filterArrJson:JSON.stringify(w??c.value),sortArrJson:JSON.stringify(u??p.value)},headers:{"xc-password":i.value}}),formColumns:N,allowCSVDownload:m}}export{$ as u};
