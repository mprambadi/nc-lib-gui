import{L as le,$ as oe,bF as se,bb as U,g as x,aM as re,r as z,bA as ce,fV as ue,H as de,a7 as fe,cG as c,gr as S,gt as Z}from"./entry.5958c07b.js";import{u as me}from"./useSharedView.e8f68616.js";import{M as he,b as ve,R as ye}from"./index.9b87fcff.js";import{a as pe}from"./useSmartsheetStore.f1a70558.js";import{a as De}from"./bases.e6c8e3c4.js";import{u as Se}from"./useViewColumns.f203dc14.js";const $e=(h,p)=>{const{api:B}=le(),{appInfo:V}=oe(),{base:v}=se(De()),{sharedView:j,fetchSharedViewData:W}=me(),A=U(he),{gridViewCols:ee}=Se(),r=x(()=>{const e=[];return Object.values(ee.value).forEach(t=>{var n;if(t.group_by){const a=(n=A==null?void 0:A.value.columns)==null?void 0:n.find(i=>i.id===t.fk_column_id);a&&e.push({column:a,sort:t.group_by_sort||"asc",order:t.group_by_order||1})}}),e.sort((t,n)=>(t.order??1/0)-(n.order??1/0)),e}),te=x(()=>!!r.value.length),{isUIAllowed:_}=re(),{sorts:w,nestedFilters:I}=pe(),O=U(ve,z(!1)),C=U(ye,ce()),d=x(()=>{var e;return((e=V.value.defaultGroupByLimit)==null?void 0:e.limitGroup)||10}),g=x(()=>{var e;return((e=V.value.defaultGroupByLimit)==null?void 0:e.limitRecord)||10}),m=z({key:"root",color:"root",count:0,column:{},nestedIn:[],paginationData:{page:1,pageSize:d.value},nested:!0,children:[],root:!0});async function M(e,t){t=t||m.value,t&&(t.paginationData.page=e,await $({offset:(e-1)*(t.paginationData.pageSize||d.value)},t))}const ne=e=>e.map(t=>({row:{...t},oldRow:{...t},rowMeta:{}})),b=(e,t)=>t.uidt===c.Checkbox?e?S.TRUE:S.FALSE:[c.User,c.CreatedBy,c.LastModifiedBy].includes(t.uidt)&&!e?S.NULL:(e&&typeof e=="object"&&(e=JSON.stringify(e)),e??S.NULL),D=z(ue.light),k=z(D.value[0]),N=()=>{const e=k.value,t=D.value.indexOf(k.value);return t===D.value.length-1?k.value=D.value[0]:k.value=D.value[t+1],e},ae=(e,t)=>{var n,a;if(t)switch(t.uidt){case c.MultiSelect:{const i=(e==null?void 0:e.split(","))||[],l=[];for(const f of i){const u=(n=t.colOptions.options)==null?void 0:n.find(R=>R.title===f);u&&l.push(u.color)}return l.join(",")}case c.SingleSelect:{const i=(a=t.colOptions.options)==null?void 0:a.find(l=>l.title===e);return i?i.color||N():"gray"}case c.Checkbox:return e?Z.success:Z.error;default:return e?N():"gray"}return e?N():"gray"},E=(e,t="")=>e.reduce((n,a)=>{if(a.key===S.NULL)n+=`${n.length?"~and":""}(${a.title},gb_null)`;else if(a.column_uidt===c.Checkbox)n+=`${n.length?"~and":""}(${a.title},${a.key===S.TRUE?"checked":"notchecked"})`;else if([c.Date,c.DateTime].includes(a.column_uidt))n+=`${n.length?"~and":""}(${a.title},eq,exactDate,${a.key})`;else if([c.User,c.CreatedBy,c.LastModifiedBy].includes(a.column_uidt))try{const i=JSON.parse(a.key);n+=`${n.length?"~and":""}(${a.title},gb_eq,${(Array.isArray(i)?i:[i]).map(l=>l.id).join(",")})`}catch(i){console.error(i)}else n+=`${n.length?"~and":""}(${a.title},gb_eq,${a.key})`;return n},t);async function $(e={},t){var u,R,Y,Q,X;if(t=t||m.value,!((u=v==null?void 0:v.value)!=null&&u.id)||!((R=h.value)!=null&&R.id)||!((Y=h.value)!=null&&Y.fk_model_id)||!t)return;if(r.value.length===0){t.children=[];return}if(t.nestedIn.length>r.value.length)return;t.nestedIn.length===0&&(k.value=D.value[0]);const n=r.value[t.nestedIn.length],a=E(t.nestedIn,p==null?void 0:p.value);if(!n||!n.column.title||O.value&&!((Q=j.value)!=null&&Q.uuid))return;const i=O.value?await B.public.dataGroupBy(j.value.uuid,{offset:((t.paginationData.page??0)-1)*(t.paginationData.pageSize??d.value),limit:t.paginationData.pageSize??d.value,...e,where:a,sort:`${n.sort==="desc"?"-":""}${n.column.title}`,column_name:n.column.title,sortsArr:w.value,filtersArr:I.value}):await B.dbViewRow.groupBy("noco",v.value.id,h.value.fk_model_id,h.value.id,{offset:((t.paginationData.page??0)-1)*(t.paginationData.pageSize??d.value),limit:t.paginationData.pageSize??d.value,...e,..._("sortSync")?{}:{sortArrJson:JSON.stringify(w.value)},..._("filterSync")?{}:{filterArrJson:JSON.stringify(I.value)},where:`${a}`,sort:`${n.sort==="desc"?"-":""}${n.column.title}`,column_name:n.column.title}),l=i.list.reduce((s,o)=>{const y=s.find(J=>J.key===b(o[n.column.column_name]??o[n.column.title],n.column));return y?(y.count+=+o.count,y.paginationData={page:1,pageSize:d.value,totalRows:y.count},s):(n.column.title&&n.column.uidt&&s.push({key:b(o[n.column.title],n.column),column:n.column,count:+o.count,color:ae(o[n.column.title],n.column),nestedIn:[...t.nestedIn,{title:n.column.title,column_name:n.column.title,key:b(o[n.column.title],n.column),column_uidt:n.column.uidt}],paginationData:{page:1,pageSize:t.nestedIn.length<r.value.length-1?d.value:g.value,totalRows:+o.count},nested:t.nestedIn.length<r.value.length-1}),s)},[]);t.children||(t.children=[]);for(const s of l){const o=(X=t.children)==null?void 0:X.find(y=>y.key===s.key);if(o){s.paginationData={page:o.paginationData.page||s.paginationData.page,pageSize:o.paginationData.pageSize||s.paginationData.pageSize,totalRows:s.count},s.color=o.color,Object.assign(o,s);continue}t.children.push(s)}t.children=t.children.filter(s=>l.find(o=>o.key===s.key)),t.count<=(t.paginationData.pageSize??d.value)&&t.children.sort((s,o)=>{const y=l.findIndex(T=>T.key===s.key),J=l.findIndex(T=>T.key===o.key);return y-J}),t.paginationData=i.pageInfo;const f=Math.max(1,Math.ceil(t.paginationData.totalRows/t.paginationData.pageSize));f<t.paginationData.page&&await M(f,t)}async function L(e,t=!1){var l,f,u;if(!((l=v==null?void 0:v.value)!=null&&l.id)||!((f=h.value)!=null&&f.id)||!((u=h.value)!=null&&u.fk_model_id)||e.children&&!t)return;e.paginationData||(e.paginationData={page:1,pageSize:g.value});const n=E(e.nestedIn,p==null?void 0:p.value),a={offset:((e.paginationData.page??0)-1)*(e.paginationData.pageSize??g.value),limit:e.paginationData.pageSize??g.value,where:`${n}`},i=O.value?await W({sortsArr:w.value,filtersArr:I.value,...a}):await B.dbViewRow.list("noco",v.value.id,h.value.fk_model_id,h.value.id,{...a,..._("sortSync")?{}:{sortArrJson:JSON.stringify(w.value)},..._("filterSync")?{}:{filterArrJson:JSON.stringify(I.value)}});e.count=i.pageInfo.totalRows??0,e.rows=ne(i.list),e.paginationData=i.pageInfo}const ie=async(e,t)=>{e.paginationData||(e.paginationData={page:1,pageSize:g.value}),e.paginationData.page=t,await L(e,!0)},P=(e,t=0)=>{if(e=e||m.value,!!e&&(t<r.value.length?e.nested=!0:e.nested=!1,e.nested?e!=null&&e.rows&&(e.rows=[]):e!=null&&e.children&&(e.children=[]),!(t>r.value.length)))for(const n of e.children||[])P(n,t+1)};de(()=>r.value.length,async()=>{r.value.length>0&&(m.value.paginationData={page:1,pageSize:d.value},m.value.column={},await $(),P(),fe(()=>C==null?void 0:C.trigger()))},{immediate:!0});const q=(e,t,n=0)=>{var i;if(t=t||m.value,n>=e.length)return t;const a=(i=t.children)==null?void 0:i.find(l=>l.key===e[n].key);return a?a.nested?q(e,a,n+1):a:t},F=e=>q(e.nestedIn.slice(0,-1)),G=(e,t)=>{var n;if(e){if(e.count+=t,e.count===0){const a=F(e);a&&(a.children=(n=a.children)==null?void 0:n.filter(i=>i.key!==e.key))}e.root||G(F(e),t)}},H=(e,t,n=0)=>{var a;if(t=t||m.value,t.nested){const i=(a=t.children)==null?void 0:a.find(l=>{if(r.value[n].column.title)return l.key===b(e.row[r.value[n].column.title],r.value[n].column)});return i?H(e,i,n+1):{found:!1,group:t}}return{found:!0,group:t}},K=e=>{var t;e=e||m.value,e&&(!e.nested&&e.rows?e.rows.forEach(n=>{var i,l,f,u;const a=H(n);a.found?a.group!==e&&(a.group&&((i=a.group.rows)==null||i.push(n),G(a.group,1)),e&&((l=e.rows)==null||l.splice(e.rows.indexOf(n),1),G(e,-1))):(e&&((f=e.rows)==null||f.splice(e.rows.indexOf(n),1),G(e,-1)),(u=a.group)!=null&&u.children&&$({},a.group))}):(t=e.children)==null||t.forEach(n=>K(n)))};return{rootGroup:m,groupBy:r,isGroupBy:te,loadGroups:$,loadGroupData:L,loadGroupPage:ie,groupWrapperChangePage:M,redistributeRows:K}};export{$e as u};
