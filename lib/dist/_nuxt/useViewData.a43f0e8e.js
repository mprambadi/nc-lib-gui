import{b as je,f as Me,a as ye,c as $e}from"./bases.965a49bb.js";import{u as Le}from"./views.2c163cf7.js";import{a as Ae,b as Fe,i as Ne}from"./virtualCell.9142cfee.js";import{M as Se,bF as ue,g as W,f8 as te,X as E,Y as b,cG as _,cn as ce,C as De,bG as Be,L as Ee,u as Ue,$ as Ge,r as Y,bb as Qe,aM as qe,eN as Je,fZ as Re}from"./entry.96205fa0.js";import{a as Xe,p as He,e as q,r as F,f as Z}from"./dataUtils.fb0a3616.js";import{b as Ke}from"./index.9b87fcff.js";import{u as Ye}from"./useSharedView.9e320acb.js";import{a as Ze}from"./useSmartsheetStore.7d51347e.js";import{a as We}from"./axios.9cbf0d09.js";function be(k){const{meta:n,viewMeta:h,formattedData:l,paginationData:w,callbacks:e}=k,{t:U}=Se(),{getMeta:ee,metas:de}=je(),{addUndo:J,clone:L,defineViewScope:X}=Me(),{base:N}=ue(ye()),{$api:H}=De(),we=W({get(){return!!l.value.length&&l.value.every(o=>o.rowMeta.selected)},set(o){l.value.forEach(i=>i.rowMeta.selected=o)}});function V(o=l.value.length,i=n.value){return l.value.splice(o,0,{row:{...Xe(i==null?void 0:i.columns)},oldRow:{},rowMeta:{new:!0}}),l.value[o]}async function G(o,i={},{metaValue:r=n.value,viewMetaValue:f=h.value}={},v=!1){var a,I;const S=o.row;o.rowMeta&&(o.rowMeta.saving=!0);try{const{missingRequiredColumns:z,insertObj:t}=await He({meta:r,ltarState:i,getMeta:ee,row:S,undo:v});if(z.size)return;const s=await H.dbViewRow.create(te,N==null?void 0:N.value.id,r==null?void 0:r.id,f==null?void 0:f.id,{...t,...i||{}});if(!v){Object.assign(o,{row:{...s,...S},rowMeta:{...o.rowMeta||{},new:void 0},oldRow:{...s}});const g=q(s,r==null?void 0:r.columns),d=F(s,r==null?void 0:r.columns),u=Z(d,l.value);J({redo:{fn:async function(y,R,C){var re,ae;y.row={...d,...y.row};const B=await G(y,R,void 0,!0);u!==-1&&C.pageSize===w.value.pageSize?C.page===w.value.page?l.value.splice(u,0,{row:{...y,...B},rowMeta:y.rowMeta,oldRow:y.oldRow}):await((re=e==null?void 0:e.changePage)==null?void 0:re.call(e,C.page)):await((ae=e==null?void 0:e.loadData)==null?void 0:ae.call(e))},args:[L(o),L(i),{page:w.value.page,pageSize:w.value.pageSize}]},undo:{fn:async function(y){await O(y),u!==-1&&l.value.splice(u,1),w.value.totalRows=w.value.totalRows-1},args:[g]},scope:X({view:h.value})})}return await((a=e==null?void 0:e.syncCount)==null?void 0:a.call(e)),s}catch(z){E.error(await b(z))}finally{o.rowMeta&&(o.rowMeta.saving=!1),await((I=e==null?void 0:e.globalCallback)==null?void 0:I.call(e))}}async function K(o,i,{metaValue:r=n.value,viewMetaValue:f=h.value}={},v=!1){var S;o.rowMeta&&(o.rowMeta.saving=!0);try{const a=q(o.row,r==null?void 0:r.columns),I=await H.dbViewRow.update(te,N==null?void 0:N.value.id,r==null?void 0:r.id,f==null?void 0:f.id,a,{[i]:o.row[i]??null});return v||(J({redo:{fn:async function(t,s,g){var u,c,y;const d=await K(t,s,void 0,!0);if(g.page===w.value.page&&g.pageSize===w.value.pageSize){const R=Z(F(t.row,(u=n==null?void 0:n.value)==null?void 0:u.columns),l.value);if(R!==-1){const C=l.value[R];Object.assign(C.row,d),Object.assign(C.oldRow,d)}else await((c=e==null?void 0:e.loadData)==null?void 0:c.call(e))}else await((y=e==null?void 0:e.changePage)==null?void 0:y.call(e,g.page))},args:[L(o),i,{page:w.value.page,pageSize:w.value.pageSize}]},undo:{fn:async function(t,s,g){var u,c,y;const d=await K({row:t.oldRow,oldRow:t.row,rowMeta:t.rowMeta},s,void 0,!0);if(g.page===w.value.page&&g.pageSize===w.value.pageSize){const R=Z(F(t.row,(u=n==null?void 0:n.value)==null?void 0:u.columns),l.value);if(R!==-1){const C=l.value[R];Object.assign(C.row,d),Object.assign(C.oldRow,d)}else await((c=e==null?void 0:e.loadData)==null?void 0:c.call(e))}else await((y=e==null?void 0:e.changePage)==null?void 0:y.call(e,g.page))},args:[L(o),i,{page:w.value.page,pageSize:w.value.pageSize}]},scope:X({view:h.value})}),Object.assign(o.row,r.columns.reduce((z,t)=>(t.title in I&&(t.uidt===_.Formula||t.uidt===_.QrCode||t.uidt===_.Barcode||t.uidt===_.Rollup||t.uidt===_.Checkbox||t.uidt===_.User||t.uidt===_.LastModifiedTime||t.uidt===_.LastModifiedBy||t.uidt===_.Lookup||t.au||t.cdf&&/ on update /i.test(t.cdf))&&(z[t.title]=I[t.title]),z),{})),Object.assign(o.oldRow,I)),await((S=e==null?void 0:e.globalCallback)==null?void 0:S.call(e)),I}catch(a){E.error(`${U("msg.error.rowUpdateFailed")} ${await b(a)}`)}finally{o.rowMeta&&(o.rowMeta.saving=!1)}}async function ne(o,i,r,f={}){if(o.rowMeta&&(o.rowMeta.changed=!1),await ce(()=>{var v,S;return!((v=o.rowMeta)!=null&&v.new&&((S=o.rowMeta)!=null&&S.saving))}).toMatch(v=>v),o.rowMeta.new)return await G(o,r,f);i&&await K(o,i,f)}async function oe(o,i,{metaValue:r=n.value,viewMetaValue:f=h.value}={},v=!1){var I,z;const S=[];for(const t of o)t.rowMeta&&(t.rowMeta.changed=!1),S.push(ce(()=>{var s,g;return!((s=t.rowMeta)!=null&&s.new&&((g=t.rowMeta)!=null&&g.saving))}).toMatch(s=>s));await Promise.all(S);const a=[];for(const t of o){t.rowMeta&&(t.rowMeta.saving=!0);const s=F(t.row,r==null?void 0:r.columns),g=i.reduce((d,u)=>(d[u]=t.row[u],d),{});a.push({...g,...s})}await H.dbTableRow.bulkUpdate(te,r==null?void 0:r.base_id,r==null?void 0:r.id,a),v||J({redo:{fn:async function(s,g,d){var u,c,y;if(await oe(s,g,{metaValue:r,viewMetaValue:f},!0),d.page===w.value.page&&d.pageSize===w.value.pageSize)for(const R of s){const C=Z(F(R.row,(u=n==null?void 0:n.value)==null?void 0:u.columns),l.value);if(C!==-1){const B=l.value[C];Object.assign(B.row,R.row),Object.assign(B.oldRow,R.row)}else{await((c=e==null?void 0:e.loadData)==null?void 0:c.call(e));break}}else await((y=e==null?void 0:e.changePage)==null?void 0:y.call(e,d.page))},args:[L(o),L(i),{page:w.value.page,pageSize:w.value.pageSize}]},undo:{fn:async function(s,g,d){var u,c,y;if(await oe(s,g,{metaValue:r,viewMetaValue:f},!0),d.page===w.value.page&&d.pageSize===w.value.pageSize)for(const R of s){const C=Z(F(R.row,(u=n==null?void 0:n.value)==null?void 0:u.columns),l.value);if(C!==-1){const B=l.value[C];Object.assign(B.row,R.row),Object.assign(B.oldRow,R.row)}else{await((c=e==null?void 0:e.loadData)==null?void 0:c.call(e));break}}else await((y=e==null?void 0:e.changePage)==null?void 0:y.call(e,d.page))},args:[L(o.map(t=>({row:t.oldRow,oldRow:t.row,rowMeta:t.rowMeta}))),i,{page:w.value.page,pageSize:w.value.pageSize}]},scope:X({view:f})});for(const t of o)t.rowMeta&&(t.rowMeta.saving=!1);r.columns.some(t=>[_.QrCode,_.LastModifiedTime,_.Barcode,_.Formula,_.Lookup,_.Rollup,_.LinkToAnotherRecord,_.LastModifiedBy].includes(t.uidt))&&await((I=e==null?void 0:e.loadData)==null?void 0:I.call(e)),await((z=e==null?void 0:e.globalCallback)==null?void 0:z.call(e))}async function ie(o,{metaValue:i=n.value,viewMetaValue:r=h.value}={}){var f,v;r&&(await H.dbTableRow.bulkUpdateAll(te,i==null?void 0:i.base_id,i==null?void 0:i.id,o,{viewId:r.id}),await((f=e==null?void 0:e.loadData)==null?void 0:f.call(e)),await((v=e==null?void 0:e.globalCallback)==null?void 0:v.call(e)))}const M=async(o,i,r,f,{metaValue:v=n.value}={})=>{try{await H.dbTableRow.nestedAdd(te,N.value.title,v==null?void 0:v.title,encodeURIComponent(o),f,r.title,encodeURIComponent(i))}catch(S){E.error(await b(S))}},Q=async(o,{metaValue:i=n.value}={})=>{var f;const r=q(o,i==null?void 0:i.columns);for(const v of(i==null?void 0:i.columns)??[]){if(v.uidt!==_.LinkToAnotherRecord)continue;const S=v.colOptions,a=(f=de.value)==null?void 0:f[S==null?void 0:S.fk_related_model_id];if(Ae(v)||Fe(v)){const I=o[v.title]??[];for(const z of I)await M(r,q(z,a.columns),v,S.type,{metaValue:i})}else Ne(v)&&o[v.title]&&await M(r,q(o[v.title],a.columns),v,S.type,{metaValue:i})}};async function O(o,{metaValue:i=n.value,viewMetaValue:r=h.value}={}){if(!o)throw new Error("Delete not allowed for table which doesn't have primary Key");const f=await H.dbViewRow.delete("noco",N.value.id,i==null?void 0:i.id,r==null?void 0:r.id,encodeURIComponent(o));return f.message?(E.info(`Record delete failed: ${`Unable to delete record with ID ${o} because of the following:
              
${f.message.join(`
`)}.

              Clear the data first & try again`})}`),!1):!0}async function fe(o,i){var r,f,v,S;try{const a=l.value[o];if(!a.rowMeta.new){const I=(f=(r=n==null?void 0:n.value)==null?void 0:r.columns)==null?void 0:f.filter(t=>t.pk).map(t=>a.row[t.title]).join("___");if(!await O(I))return;i||J({redo:{fn:async function(s){var u;await O(s);const g=F(a.row,(u=n==null?void 0:n.value)==null?void 0:u.columns),d=Z(g,l.value);d!==-1&&l.value.splice(d,1),w.value.totalRows=w.value.totalRows-1},args:[I]},undo:{fn:async function(s,g,d){var c,y,R;const u=F(s.row,(c=n.value)==null?void 0:c.columns);s.row={...u,...s.row},await G(s,g,{},!0),Q(s.row),o!==-1&&d.pageSize===w.value.pageSize?d.page===w.value.page?l.value.splice(o,0,s):await((y=e==null?void 0:e.changePage)==null?void 0:y.call(e,d.page)):await((R=e==null?void 0:e.loadData)==null?void 0:R.call(e))},args:[L(a),{},{page:w.value.page,pageSize:w.value.pageSize}]},scope:X({view:h.value})})}l.value.splice(o,1),await((v=e==null?void 0:e.syncCount)==null?void 0:v.call(e))}catch(a){E.error(`${U("msg.error.deleteRowFailed")}: ${await b(a)}`)}await((S=e==null?void 0:e.globalCallback)==null?void 0:S.call(e))}async function ve(){var r,f,v,S,a;let o=l.value.length;const i=[];for(;o--;)try{const{row:I,rowMeta:z}=l.value[o];if(!z.selected)continue;if(!z.new){const t=(f=(r=n==null?void 0:n.value)==null?void 0:r.columns)==null?void 0:f.filter(g=>g.pk).map(g=>I[g.title]).join("___");if(!await O(t))continue;i.push({id:t,row:L(l.value[o]),rowIndex:o})}l.value.splice(o,1)}catch(I){return E.error(`${U("msg.error.deleteRowFailed")}: ${await b(I)}`)}J({redo:{fn:async function(z){var t,s;for(const{id:g,row:d}of z){await O(g);const u=F(d.row,(t=n==null?void 0:n.value)==null?void 0:t.columns),c=Z(u,l.value);c!==-1&&l.value.splice(c,1),w.value.totalRows=w.value.totalRows-1}await((s=e==null?void 0:e.syncPagination)==null?void 0:s.call(e))},args:[i]},undo:{fn:async function(z,t){var s,g,d;for(const{row:u,rowIndex:c}of z.slice().reverse()){const y=F(u.row,(s=n.value)==null?void 0:s.columns);u.row={...y,...u.row},await G(u,{},{},!0),Q(u.row),c!==-1&&t.pageSize===w.value.pageSize?t.page===w.value.page?l.value.splice(c,0,u):await((g=e==null?void 0:e.changePage)==null?void 0:g.call(e,t.page)):await((d=e==null?void 0:e.loadData)==null?void 0:d.call(e))}},args:[i,{page:w.value.page,pageSize:w.value.pageSize}]},scope:X({view:h.value})}),await((v=e==null?void 0:e.syncCount)==null?void 0:v.call(e)),await((S=e==null?void 0:e.syncPagination)==null?void 0:S.call(e)),await((a=e==null?void 0:e.globalCallback)==null?void 0:a.call(e))}async function ge(o){var S,a,I,z,t;if(!o._start||!o._end)return;const i=Math.max(o._start.row,o._end.row),r=Math.min(o._start.row,o._end.row);let f=i+1;const v=[];for(;f--;){try{const{row:s,rowMeta:g}=l.value[f];if(!g.new){const d=(a=(S=n==null?void 0:n.value)==null?void 0:S.columns)==null?void 0:a.filter(c=>c.pk).map(c=>s[c.title]).join("___");if(!await O(d))continue;v.push({id:d,row:L(l.value[f]),rowIndex:f})}l.value.splice(f,1)}catch(s){return E.error(`${U("msg.error.deleteRowFailed")}: ${await b(s)}`)}if(f===r)break}J({redo:{fn:async function(g){var d,u;for(const{id:c,row:y}of g){await O(c);const R=F(y.row,(d=n==null?void 0:n.value)==null?void 0:d.columns),C=Z(R,l.value);C!==-1&&l.value.splice(C,1),w.value.totalRows=w.value.totalRows-1}await((u=e==null?void 0:e.syncPagination)==null?void 0:u.call(e))},args:[v]},undo:{fn:async function(g,d){var u,c,y;for(const{row:R,rowIndex:C}of g.slice().reverse()){const B=F(R.row,(u=n.value)==null?void 0:u.columns);R.row={...B,...R.row},await G(R,{},{},!0),C!==-1&&d.pageSize===w.value.pageSize?d.page===w.value.page?l.value.splice(C,0,R):await((c=e==null?void 0:e.changePage)==null?void 0:c.call(e,d.page)):await((y=e==null?void 0:e.loadData)==null?void 0:y.call(e))}},args:[v,{page:w.value.page,pageSize:w.value.pageSize}]},scope:X({view:h.value})}),await((I=e==null?void 0:e.syncCount)==null?void 0:I.call(e)),await((z=e==null?void 0:e.syncPagination)==null?void 0:z.call(e)),await((t=e==null?void 0:e.globalCallback)==null?void 0:t.call(e))}return{insertRow:G,updateRowProperty:K,addEmptyRow:V,deleteRow:fe,deleteRowById:O,deleteSelectedRows:ve,deleteRangeOfRows:ge,updateOrSaveRow:ne,bulkUpdateRows:oe,bulkUpdateView:ie,selectedAllRecords:we,removeRowIfNew:o=>{const i=l.value.indexOf(o);return i>-1&&o.rowMeta.new?(l.value.splice(i,1),!0):!1}}}const Ve=k=>k.map(n=>({row:{...n},oldRow:{...n},rowMeta:{}}));function wo(k,n,h){const{activeTableId:l,activeTable:w}=ue($e()),e=W(()=>k.value||w.value),U=W(()=>{var p;return((p=k.value)==null?void 0:p.id)||l.value}),{t:ee}=Se(),de=Be("optimisedQuery",()=>!0),{api:J,isLoading:L,error:X}=Ee(),N=Ue(),H=N.currentRoute,{appInfo:we}=Ge(),V=we.value.defaultLimit||25,G=Y({page:1,pageSize:V}),K=Y([]),ne=Y(),oe=Y(),ie=Y(),M=Y([]),Q=Qe(Ke,Y(!1)),{base:O,isSharedBase:fe}=ue(ye()),{sharedView:ve,fetchSharedViewData:ge,paginationData:pe}=Ye(),{$api:o}=De(),{sorts:i,nestedFilters:r}=Ze(),{isUIAllowed:f}=qe(),v=W(()=>H.value.query),{isPaginationLoading:S}=ue(Le()),a=W({get:()=>Q.value?pe.value:G.value,set:p=>{Q.value?pe.value=p:G.value=p}}),I=W(()=>{var D;const p=se();return((D=a.value)==null?void 0:D.isLastPage)&&p===M.value.length-1}),z=W(()=>{var D;const p=se();return((D=a.value)==null?void 0:D.isFirstPage)&&p===0}),t=W(()=>({offset:((a.value.page??0)-1)*(a.value.pageSize??V),limit:a.value.pageSize??V,where:(h==null?void 0:h.value)??""}));async function s(){var D,m;const{count:p}=await o.dbViewRow.count(te,(D=O==null?void 0:O.value)==null?void 0:D.id,U.value,(m=n==null?void 0:n.value)==null?void 0:m.id);a.value.totalRows=p}async function g(){var P;const p=((P=a.value)==null?void 0:P.totalRows)??1/0,D=a.value.pageSize??V,m=a.value.page??1,j=Math.ceil(p/D),$=Math.max(1,Math.min(j,m));m>$?R==null||R($):await c({offset:($-1)*D,where:h==null?void 0:h.value})}async function d(){var D,m,j,$,P;if(!f("commentCount")||Q.value||fe.value)return;const p=(m=(D=M.value)==null?void 0:D.filter(({rowMeta:{new:T}})=>!T))==null?void 0:m.map(({row:T})=>{var x;return q(T,(x=e==null?void 0:e.value)==null?void 0:x.columns)});if(!(!(p!=null&&p.length)||p!=null&&p.some(T=>!T))){K.value=await o.utils.commentCount({ids:p,fk_model_id:U.value});for(const T of M.value){const x=q(T.row,(j=e.value)==null?void 0:j.columns);T.rowMeta.commentCount=+(((P=($=K.value)==null?void 0:$.find(A=>A.row_id===x))==null?void 0:P.count)||0)}}}const u=Y();async function c(p={}){var $,P,T;if((!(($=O==null?void 0:O.value)!=null&&$.id)||!U.value||!((P=n.value)!=null&&P.id))&&!Q.value)return;u.value&&u.value.cancel();const D=We.CancelToken;u.value=D.source(),S.value=!0;let m;try{m=Q.value?await ge({sortsArr:i.value,filtersArr:r.value,where:h==null?void 0:h.value}):await J.dbViewRow.list("noco",O.value.id,U.value,n.value.id,{...t.value,...p,...f("sortSync")?{}:{sortArrJson:JSON.stringify(i.value)},...f("filterSync")?{}:{filterArrJson:JSON.stringify(r.value)},where:h==null?void 0:h.value},{cancelToken:u.value.token})}catch(x){if(x.code==="ERR_CANCELED")return;throw x}M.value=Ve(m.list),a.value=m.pageInfo,S.value=!1;const j=Math.max(1,Math.ceil(a.value.totalRows/a.value.pageSize));j<a.value.page&&await R(j),((T=n.value)==null?void 0:T.type)===Je.GRID&&d()}async function y(){var p,D;(p=n==null?void 0:n.value)!=null&&p.id&&(ne.value=Q.value?(D=ve.value)==null?void 0:D.view:await o.dbView.galleryRead(n.value.id))}async function R(p){a.value.page=p,await c({offset:(p-1)*(a.value.pageSize||V),where:h==null?void 0:h.value})}const{insertRow:C,updateRowProperty:B,addEmptyRow:re,deleteRow:ae,deleteRowById:he,deleteSelectedRows:Ie,deleteRangeOfRows:ze,updateOrSaveRow:me,bulkUpdateRows:Ce,bulkUpdateView:xe,selectedAllRecords:Pe,removeRowIfNew:_e}=be({meta:e,viewMeta:n,formattedData:M,paginationData:a,callbacks:{changePage:R,loadData:c,syncCount:s,syncPagination:g}});async function Oe(){var p,D,m;if((p=n==null?void 0:n.value)!=null&&p.id)try{const{columns:j,...$}=await o.dbView.formRead(n.value.id),P=(j||[]).reduce((x,A)=>({...x,[A.fk_column_id]:A}),{});let T=1;ie.value=$,oe.value=(m=(D=e==null?void 0:e.value)==null?void 0:D.columns)==null?void 0:m.map(x=>{var A;return{...x,fk_column_id:x.id,fk_view_id:(A=n.value)==null?void 0:A.id,...P[x.id]?P[x.id]:{},order:P[x.id]&&P[x.id].order||T++,id:P[x.id]&&P[x.id].id}}).sort((x,A)=>x.order-A.order)}catch(j){return E.error(`${ee("msg.error.setFormDataFailed")}: ${await b(j)}`)}}async function Te(p){var D;try{if(!((D=n==null?void 0:n.value)!=null&&D.id)||!p)return;await o.dbView.formUpdate(n.value.id,p)}catch(m){return E.error(`${ee("msg.error.formViewUpdateFailed")}: ${await b(m)}`)}}function se(){return M.value.findIndex(p=>{var D;return v.value.rowId===q(p.row,(D=e.value)==null?void 0:D.columns)})}return{error:X,isLoading:L,loadData:c,paginationData:a,queryParams:t,formattedData:M,insertRow:C,updateRowProperty:B,changePage:R,addEmptyRow:re,deleteRow:ae,deleteRowById:he,deleteSelectedRows:Ie,deleteRangeOfRows:ze,updateOrSaveRow:me,bulkUpdateRows:Ce,bulkUpdateView:xe,selectedAllRecords:Pe,syncCount:s,syncPagination:g,galleryData:ne,loadGalleryData:y,loadFormView:Oe,formColumnData:oe,formViewData:ie,updateFormView:Te,aggCommentCount:K,loadAggCommentsCount:d,removeRowIfNew:_e,navigateToSiblingRow:async p=>{var P,T,x,A,le;let m=se()+(p===Re.NEXT?1:-1);for(;(T=(P=M.value[m])==null?void 0:P.rowMeta)!=null&&T.new;)m=m+(p===Re.NEXT?1:-1);const j=((x=a==null?void 0:a.value)==null?void 0:x.page)||1;if(m<0){if(j===1)return E.info(ee("msg.info.noMoreRecords"));await R(j-1),m=M.value.length-1}else if(m>=M.value.length){if((A=a==null?void 0:a.value)!=null&&A.isLastPage)return E.info(ee("msg.info.noMoreRecords"));await R(j+1),m=0}const $=q(M.value[m].row,(le=e.value)==null?void 0:le.columns);$&&N.push({query:{...v.value,rowId:$}})},getExpandedRowIndex:se,optimisedQuery:de,islastRow:I,isFirstRow:z}}export{be as a,wo as u};
