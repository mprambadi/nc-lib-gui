import{_ as Be}from"./Button.vue.02ce6d5b.js";import{_ as Ve}from"./Icon.vue.6d0583a0.js";import{_ as ze}from"./Editor.vue.1fd573b4.js";import{a as Oe,u as Qe,d as Re}from"./bases.965a49bb.js";import{f as Ae,bF as De,bb as qe,g as K,r as m,L as Ge,M as Je,g8 as Y,bE as f,g9 as v,H as Ke,i as Ye,o as u,c as U,a as c,t as d,b as l,w as s,ae as g,O as t,U as x,V as F,ga as He,P as C,d as _,T as H,cb as We,gb as W,Q as X,R as Z,W as M,X as B,Y as de,gc as Xe,af as Ze,ah as et,p as tt,e as at,C as nt}from"./entry.96205fa0.js";import{d as ot,g as lt,f as p}from"./validation.64563eeb.js";import{k as st}from"./index.9b87fcff.js";import{r as it}from"./fileUtils.43128440.js";import{F as pe}from"./index.886d43e1.js";import"./index.1431a68b.js";import{I as rt}from"./Input.3f1aaf0c.js";import{C as ct}from"./index.c4d36e30.js";import{_ as ut,C as dt}from"./index.e7262e5b.js";import{_ as pt}from"./FormItem.9f1f85f2.js";import{S as mt,_ as ft}from"./index.b5e393d6.js";import{_ as vt}from"./index.d579646c.js";import{_ as bt}from"./Password.803cc3dc.js";import{_ as _t}from"./index.c968c966.js";import{_ as St}from"./_plugin-vue_export-helper.c27b6911.js";import"./index.9e8f59f4.js";import"./debounce.1d5af9bf.js";import"./toNumber.ed208f2f.js";import"./isSymbol.d46b4957.js";import"./deepCompare.d32ec333.js";import"./workerUtils.81f9c0e3.js";import"./index.0c5b3837.js";import"./useSize.c98e621d.js";import"./identity.309e9ead.js";import"./_flatRest.ce557a88.js";import"./isPlainObject.631eb8fb.js";import"./_getPrototype.459a70cf.js";import"./FormItemContext.b19eb48c.js";import"./SearchOutlined.c9794270.js";import"./TextArea.b81a19ed.js";import"./antInputDirective.8ac36ea7.js";import"./index.e1ceba77.js";import"./Dropdown.1dedd322.js";import"./useState.5a301439.js";import"./useRefs.3fea1e39.js";import"./isMobile.e2e89480.js";import"./index.208c1883.js";import"./Col.b3c5d725.js";import"./responsiveObserve.358bcfe9.js";import"./RightOutlined.3ce786f5.js";import"./toArray.3561b70e.js";import"./useMemo.dbc63a5f.js";import"./CheckOutlined.3b90c20d.js";const yt=I=>(tt("data-v-e5f7b68a"),I=I(),at(),I),gt={class:"edit-source bg-white relative flex flex-col justify-start gap-2 w-full p-2"},Ct={class:"prose-2xl font-bold self-start"},kt={class:"nc-scrollbar-md",style:{maxHeight:"60vh"}},wt={class:"flex justify-end gap-2"},$t={class:"flex items-center gap-2"},Ut={class:"flex gap-2"},ht={class:"flex py-1 items-center gap-1"},Pt=yt(()=>c("span",null,":",-1)),xt={class:"flex items-center justify-center"},It={class:"flex justify-end"},Nt={class:"flex justify-end gap-2"},Tt={class:"w-full flex items-center mt-2 text-[#e65100]"},Lt=Ae({__name:"EditBase",props:{sourceId:{}},emits:["baseUpdated","close"],setup(I,{emit:me}){const ee=I,te=me,fe=Oe(),ve=Qe(),{base:N}=De(fe),V=qe(st,void 0),be=K(()=>{var n;return(V==null?void 0:V.value)??((n=N.value)==null?void 0:n.id)}),{refreshCommandPalette:_e}=Re(),Se=pe.useForm,k=m(!1),z=m(!1),ae=m(),{api:E}=Ge(),{$e:ne}=nt(),{t:oe}=Je(),ye=m(!1),a=m({title:"",dataSource:{...Y(f.MYSQL)},inflection:{inflectionColumn:"none",inflectionTable:"none"},sslUse:v.No,extraParameters:[]}),T=m({title:"",dataSource:{...Y(f.MYSQL)},inflection:{inflectionColumn:"none",inflectionTable:"none"},sslUse:v.No,extraParameters:[]}),ge=K(()=>({title:[ot],extraParameters:[lt],"dataSource.client":[p()],...a.value.dataSource.client===f.SQLITE?{"dataSource.connection.connection.filename":[p()]}:a.value.dataSource.client===f.SNOWFLAKE?{"dataSource.connection.account":[p()],"dataSource.connection.username":[p()],"dataSource.connection.password":[p()],"dataSource.connection.warehouse":[p()],"dataSource.connection.database":[p()],"dataSource.connection.schema":[p()]}:{"dataSource.connection.host":[p()],"dataSource.connection.port":[p()],"dataSource.connection.user":[p()],"dataSource.connection.password":[p()],"dataSource.connection.database":[p()],...[f.PG,f.MSSQL].includes(a.value.dataSource.client)?{"dataSource.searchPath.0":[p()]}:{}}})),{validate:le,validateInfos:S}=Se(a,ge),Ce=()=>{a.value.dataSource={...Y(a.value.dataSource.client)}},ke=n=>{if(a.value.dataSource.client!==f.SQLITE){const e=a.value.dataSource.connection;switch(n){case v.No:delete e.ssl;break;case v.Allowed:e.ssl="true";break;default:e.ssl={ca:"",cert:"",key:""};break}}},O=()=>{if(a.value.dataSource.client!==f.SQLITE){const n=a.value.dataSource.connection;n.ssl?typeof n.ssl=="string"?a.value.sslUse=v.Allowed:a.value.sslUse=v.Preferred:a.value.sslUse=v.No}},we=()=>{a.value.extraParameters.push({key:"",value:""})},$e=n=>{a.value.extraParameters.splice(n,1)},se=["camelize","none"],h=m(""),P=m(!1),L=m(!1),Q=m(),R=m(),A=m(),D=(n,e)=>{e&&it(e,i=>{"ssl"in a.value.dataSource.connection&&typeof a.value.dataSource.connection.ssl=="object"&&(a.value.dataSource.connection.ssl[n]=i??"")})},q=K(()=>!!a.value.sslUse&&a.value.sslUse!==v.No&&a.value.sslUse!==v.Allowed);function ie(){const n=Object.fromEntries(new Map(a.value.extraParameters.map(i=>[i.key,i.value]))),e={...a.value.dataSource.connection,...n};return"ssl"in e&&e.ssl&&(a.value.sslUse===v.No||typeof e.ssl=="object"&&Object.values(e.ssl).every(i=>i==null))&&delete e.ssl,e}const re=()=>{var n,e,i,r,y;(y=(r=(i=(e=(n=ae.value)==null?void 0:n.$el.querySelector(".ant-form-item-explain-error"))==null?void 0:e.parentNode)==null?void 0:i.parentNode)==null?void 0:r.querySelector("input"))==null||y.focus()},Ue=async()=>{var n,e;try{await le()}catch{re();return}try{if(!((n=N.value)!=null&&n.id))return;const i=ie(),r={...a.value.dataSource,connection:i};await E.source.update((e=N.value)==null?void 0:e.id,ee.sourceId,{alias:a.value.title,type:a.value.dataSource.client,config:r,inflection_column:a.value.inflection.inflectionColumn,inflection_table:a.value.inflection.inflectionTable}),ne("a:source:edit:extdb"),await ve.loadProject(be.value,!0),te("baseUpdated"),te("close")}catch(i){B.error(await de(i))}finally{_e()}},he=async()=>{try{await le()}catch{re();return}ne("a:source:edit:extdb:test-connection",[]);try{if(z.value=!0,a.value.dataSource.client===f.SQLITE)k.value=!0;else{const n=ie();n.database=Xe(a.value.dataSource);const e={...a.value.dataSource,connection:n},i=await E.utils.testConnection(e);i.code===0?k.value=!0:(k.value=!1,B.error(`${oe("msg.error.dbConnectionFailed")} ${i.message}`))}}catch(n){k.value=!1,B.error(await de(n))}z.value=!1},Pe=async()=>{if(!h.value||h.value==="")return;const n=await E.utils.urlToConfig({url:h.value});n?(a.value.dataSource.client=n.client,a.value.dataSource.connection={...n.connection}):B.error(oe("msg.error.invalidURL")),L.value=!1,O()},xe=()=>{T.value=a.value,P.value=!0},Ie=()=>{a.value=T.value,P.value=!1,O()};return Ke(()=>a.value.dataSource,()=>k.value=!1,{deep:!0}),Ye(async()=>{var n,e;if((n=N.value)!=null&&n.id){const i=["host","port","user","password","database"],r=await E.source.read((e=N.value)==null?void 0:e.id,ee.sourceId),y=Object.entries(r.config.connection).filter(([w])=>!i.includes(w)).map(([w,G])=>({key:w,value:G}));a.value={title:r.alias||"",dataSource:r.config,inflection:{inflectionColumn:r.inflection_column,inflectionTable:r.inflection_table},extraParameters:y,sslUse:v.No},O()}}),(n,e)=>{const i=rt,r=pt,y=mt,w=ft,G=vt,Ne=bt,$=Be,J=Ze,ce=_t,Te=ct,Le=ut,Fe=dt,Ee=Ve,je=pe,Me=ze,ue=et;return u(),U("div",gt,[c("h1",Ct,d(n.$t("activity.editSource")),1),l(je,{ref_key:"form",ref:ae,model:t(a),name:"external-base-create-form",layout:"horizontal","no-style":"","label-col":{span:8}},{default:s(()=>[c("div",kt,[l(r,g({label:"Source Name"},t(S).title),{default:s(()=>[l(i,{value:t(a).title,"onUpdate:value":e[0]||(e[0]=o=>t(a).title=o),class:"nc-extdb-proj-name"},null,8,["value"])]),_:1},16),l(r,g({label:n.$t("labels.dbType")},t(S)["dataSource.client"]),{default:s(()=>[l(w,{value:t(a).dataSource.client,"onUpdate:value":e[1]||(e[1]=o=>t(a).dataSource.client=o),class:"nc-extdb-db-type","dropdown-class-name":"nc-dropdown-ext-db-type",onChange:Ce},{default:s(()=>[(u(!0),U(x,null,F(t(He),o=>(u(),C(y,{key:o.value,value:o.value},{default:s(()=>[_(d(o.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1},16,["label"]),t(a).dataSource.client===t(f).SQLITE?(u(),C(r,g({key:0,label:n.$t("labels.sqliteFile")},t(S)["dataSource.connection.connection.filename"]),{default:s(()=>[l(i,{value:t(a).dataSource.connection.connection.filename,"onUpdate:value":e[2]||(e[2]=o=>t(a).dataSource.connection.connection.filename=o)},null,8,["value"])]),_:1},16,["label"])):(u(),U(x,{key:1},[l(r,g({label:n.$t("labels.hostAddress")},t(S)["dataSource.connection.host"]),{default:s(()=>[l(i,{value:t(a).dataSource.connection.host,"onUpdate:value":e[3]||(e[3]=o=>t(a).dataSource.connection.host=o),class:"nc-extdb-host-address"},null,8,["value"])]),_:1},16,["label"]),l(r,g({label:n.$t("labels.port")},t(S)["dataSource.connection.port"]),{default:s(()=>[l(G,{value:t(a).dataSource.connection.port,"onUpdate:value":e[4]||(e[4]=o=>t(a).dataSource.connection.port=o),class:"!w-full nc-extdb-host-port"},null,8,["value"])]),_:1},16,["label"]),l(r,g({label:n.$t("labels.username")},t(S)["dataSource.connection.user"]),{default:s(()=>[l(i,{value:t(a).dataSource.connection.user,"onUpdate:value":e[5]||(e[5]=o=>t(a).dataSource.connection.user=o),class:"nc-extdb-host-user"},null,8,["value"])]),_:1},16,["label"]),l(r,{label:n.$t("labels.password")},{default:s(()=>[l(Ne,{value:t(a).dataSource.connection.password,"onUpdate:value":e[6]||(e[6]=o=>t(a).dataSource.connection.password=o),class:"nc-extdb-host-password"},null,8,["value"])]),_:1},8,["label"]),l(r,g({label:n.$t("labels.database")},t(S)["dataSource.connection.database"]),{default:s(()=>[l(i,{value:t(a).dataSource.connection.database,"onUpdate:value":e[7]||(e[7]=o=>t(a).dataSource.connection.database=o),placeholder:n.$t("labels.dbCreateIfNotExists"),class:"nc-extdb-host-database"},null,8,["value","placeholder"])]),_:1},16,["label"]),[t(f).MSSQL,t(f).PG].includes(t(a).dataSource.client)&&t(a).dataSource.searchPath?(u(),C(r,g({key:0,label:n.$t("labels.schemaName")},t(S)["dataSource.searchPath.0"]),{default:s(()=>[l(i,{value:t(a).dataSource.searchPath[0],"onUpdate:value":e[8]||(e[8]=o=>t(a).dataSource.searchPath[0]=o)},null,8,["value"])]),_:1},16,["label"])):H("",!0),c("div",wt,[l($,{size:"small",type:"ghost",class:"nc-extdb-btn-import-url !rounded-md",onClick:e[9]||(e[9]=We(o=>L.value=!0,["stop"]))},{default:s(()=>[_(d(n.$t("activity.useConnectionUrl")),1)]),_:1})]),l(Fe,{ghost:"","expand-icon-position":"right",class:"!mt-6"},{default:s(()=>[l(Le,{key:"1"},{header:s(()=>[c("div",$t,[c("span",null,d(n.$t("title.advancedParameters")),1)])]),default:s(()=>[l(r,{label:"SSL mode"},{default:s(()=>[l(w,{value:t(a).sslUse,"onUpdate:value":e[10]||(e[10]=o=>t(a).sslUse=o),"dropdown-class-name":"nc-dropdown-ssl-mode",onSelect:ke},{default:s(()=>[(u(!0),U(x,null,F(Object.values(t(v)),o=>(u(),C(y,{key:o,value:o},{default:s(()=>[_(d(o),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),l(r,{label:"SSL keys"},{default:s(()=>[c("div",Ut,[l(J,{placement:"top"},{title:s(()=>[c("span",null,d(n.$t("tooltip.clientCert")),1)]),default:s(()=>[l($,{size:"small",disabled:!t(q),class:"shadow",onClick:e[11]||(e[11]=o=>{var b;return(b=t(A))==null?void 0:b.click()})},{default:s(()=>[_(d(n.$t("labels.clientCert")),1)]),_:1},8,["disabled"])]),_:1}),l(J,{placement:"top"},{title:s(()=>[c("span",null,d(n.$t("tooltip.clientKey")),1)]),default:s(()=>[l($,{size:"small",disabled:!t(q),class:"shadow",onClick:e[12]||(e[12]=o=>{var b;return(b=t(R))==null?void 0:b.click()})},{default:s(()=>[_(d(n.$t("labels.clientKey")),1)]),_:1},8,["disabled"])]),_:1}),l(J,{placement:"top"},{title:s(()=>[c("span",null,d(n.$t("tooltip.clientCA")),1)]),default:s(()=>[l($,{size:"small",disabled:!t(q),class:"shadow",onClick:e[13]||(e[13]=o=>{var b;return(b=t(Q))==null?void 0:b.click()})},{default:s(()=>[_(d(n.$t("labels.serverCA")),1)]),_:1},8,["disabled"])]),_:1})])]),_:1}),c("input",{ref_key:"caFileInput",ref:Q,type:"file",class:"!hidden",onChange:e[14]||(e[14]=o=>D(t(W).ca,t(Q)))},null,544),c("input",{ref_key:"certFileInput",ref:A,type:"file",class:"!hidden",onChange:e[15]||(e[15]=o=>D(t(W).cert,t(A)))},null,544),c("input",{ref_key:"keyFileInput",ref:R,type:"file",class:"!hidden",onChange:e[16]||(e[16]=o=>D(t(W).key,t(R)))},null,544),l(ce),l(r,g({class:"mb-2",label:n.$t("labels.extraConnectionParameters")},t(S).extraParameters),{default:s(()=>[l(Te,null,{default:s(()=>[(u(!0),U(x,null,F(t(a).extraParameters,(o,b)=>(u(),U("div",{key:b},[c("div",ht,[l(i,{value:o.key,"onUpdate:value":j=>o.key=j},null,8,["value","onUpdate:value"]),Pt,l(i,{value:o.value,"onUpdate:value":j=>o.value=j},null,8,["value","onUpdate:value"]),(u(),C(X(t(Z).close),{style:{"font-size":"1.5em",color:"red"},onClick:j=>$e(b)},null,8,["onClick"]))])]))),128)),l($,{size:"small",type:"dashed",class:"w-full caption mt-2",onClick:we},{default:s(()=>[c("div",xt,[(u(),C(X(t(Z).plus)))])]),_:1})]),_:1})]),_:1},16,["label"]),l(ce),l(r,{label:n.$t("labels.inflection.tableName")},{default:s(()=>[l(w,{value:t(a).inflection.inflectionTable,"onUpdate:value":e[17]||(e[17]=o=>t(a).inflection.inflectionTable=o),"dropdown-class-name":"nc-dropdown-inflection-table-name"},{default:s(()=>[(u(),U(x,null,F(se,o=>l(y,{key:o,value:o},{default:s(()=>[_(d(o),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])]),_:1},8,["label"]),l(r,{label:n.$t("labels.inflection.columnName")},{default:s(()=>[l(w,{value:t(a).inflection.inflectionColumn,"onUpdate:value":e[18]||(e[18]=o=>t(a).inflection.inflectionColumn=o),"dropdown-class-name":"nc-dropdown-inflection-column-name"},{default:s(()=>[(u(),U(x,null,F(se,o=>l(y,{key:o,value:o},{default:s(()=>[_(d(o),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])]),_:1},8,["label"]),c("div",It,[l($,{size:"small",type:"primary",class:"!rounded-md",onClick:e[19]||(e[19]=o=>xe())},{default:s(()=>[_(d(n.$t("activity.editConnJson")),1)]),_:1})])]),_:1})]),_:1})],64))]),l(r,{class:"flex justify-end !mt-5"},{default:s(()=>[c("div",Nt,[l($,{type:t(k)?"ghost":"primary",size:"small",class:"nc-extdb-btn-test-connection !rounded-md",loading:t(z),onClick:he},{default:s(()=>[t(k)?(u(),C(Ee,{key:0,icon:"circleCheck",class:"text-primary mr-2"})):H("",!0),_(" "+d(n.$t("activity.testDbConn")),1)]),_:1},8,["type","loading"]),l($,{class:"nc-extdb-btn-submit !rounded-md",size:"small",type:"primary",disabled:!t(k),loading:t(ye),onClick:Ue},{default:s(()=>[_(d(n.$t("general.submit")),1)]),_:1},8,["disabled","loading"])])]),_:1}),c("div",Tt,[(u(),C(X(t(Z).warning),{class:"mr-2 mb-5.9"})),c("div",null,d(n.$t("msg.warning.dbValid")),1)])]),_:1},8,["model"]),l(ue,{visible:t(P),"onUpdate:visible":e[21]||(e[21]=o=>M(P)?P.value=o:null),title:n.$t("activity.editConnJson"),width:"500px","wrap-class-name":"nc-modal-edit-connection-json",onOk:Ie},{default:s(()=>[t(P)?(u(),C(Me,{key:0,modelValue:t(T),"onUpdate:modelValue":e[20]||(e[20]=o=>M(T)?T.value=o:null),class:"h-[400px] w-full"},null,8,["modelValue"])):H("",!0)]),_:1},8,["visible","title"]),l(ue,{visible:t(L),"onUpdate:visible":e[23]||(e[23]=o=>M(L)?L.value=o:null),title:n.$t("activity.useConnectionUrl"),width:"600px","ok-text":n.$t("general.ok"),"cancel-text":n.$t("general.cancel"),"wrap-class-name":"nc-modal-connection-url",onOk:Pe},{default:s(()=>[l(i,{value:t(h),"onUpdate:value":e[22]||(e[22]=o=>M(h)?h.value=o:null)},null,8,["value"])]),_:1},8,["visible","title","ok-text","cancel-text"])])}}});const ha=St(Lt,[["__scopeId","data-v-e5f7b68a"]]);export{ha as default};
