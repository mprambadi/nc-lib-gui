var Ie=Object.defineProperty;var Oe=(t,o,s)=>o in t?Ie(t,o,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[o]=s;var q=(t,o,s)=>(Oe(t,typeof o!="symbol"?o+"":o,s),s);import{_ as Le}from"./Icon.vue.129448d5.js";import{_ as $e}from"./Button.vue.c3ca0e8f.js";import{M as Re}from"./index.9b87fcff.js";import{gQ as E,f as Ue,cG as W,a5 as Me,M as Ne,bb as Be,r as _,g as M,fU as je,g0 as Ee,ge as Pe,i as Ve,gR as Ae,gS as De,o as f,c as k,O as n,a as c,P as N,Q as B,R as z,d as de,t as $,b as v,w as y,U as G,V as Fe,S as K,T as C,bv as Q,cb as j,ae as qe,gT as We,gU as ze,fk as Ge,a7 as Ke,p as Qe,e as He}from"./entry.5958c07b.js";import{b as Je,u as Xe}from"./EditOrAddProvider.vue.31035ffc.js";import{b as Ye}from"./bases.e6c8e3c4.js";import{b as Ze,_ as et,a as tt}from"./index.160bdadc.js";import{_ as st}from"./TextArea.9074ff05.js";import{_ as ot}from"./FormItem.0bbf90a3.js";import{_ as rt}from"./_plugin-vue_export-helper.c27b6911.js";import"./index.55641318.js";import"./debounce.7c24f171.js";import"./toNumber.e09cd85a.js";import"./isSymbol.114fe557.js";import"./views.4281cbf1.js";import"./useSharedView.e8f68616.js";import"./validation.2de04583.js";import"./index.0feaca99.js";import"./index.b06c8b67.js";import"./useSize.fad35fe8.js";import"./identity.34c7640e.js";import"./_flatRest.39582a58.js";import"./isPlainObject.ccda79fe.js";import"./_getPrototype.c1f3bae2.js";import"./FormItemContext.ddc65fa5.js";import"./vuedraggable.umd.00f5fccc.js";import"./v3-infinite-loading.660bd977.js";import"./index.dc13a4d6.js";import"./Dropdown.041b2468.js";import"./RightOutlined.7161c742.js";import"./index.ae235b22.js";import"./Input.dca3a2bc.js";import"./antInputDirective.8ac36ea7.js";import"./SearchOutlined.a517903c.js";import"./Password.f52125e7.js";import"./cell.165313cd.js";import"./index.5e1434a7.js";import"./Checkbox.2e7b0035.js";import"./createForOfIteratorHelper.33de41ba.js";import"./index.5c6e4286.js";import"./toArray.fd74ce6f.js";import"./isMobile.e2e89480.js";import"./useMemo.1dd071d8.js";import"./useState.b891c8bb.js";import"./CheckOutlined.1fe5f230.js";import"./index.023e2de7.js";import"./LeftOutlined.1d2f193f.js";import"./useBreakpoint.cbf2ba72.js";import"./responsiveObserve.0baefba6.js";import"./Col.a97e3e76.js";import"./eagerComputed.ab57921b.js";class nt{constructor(){q(this,"trie");q(this,"suggestions");this.trie={},this.suggestions=[]}newNode(){return{value:[],isLeaf:!1,children:{}}}add(o){Object.keys(this.trie).length===0&&(this.trie=this.newNode());let s=this.trie;for(const l of o.text.toLowerCase())l in s.children||(s.children[l]=this.newNode()),s=s.children[l];s.value=s.value||[],s.value.push(o),s.isLeaf=!0}find(o){Object.keys(this.trie).length===0&&(this.trie=this.newNode());let s=this.trie;for(const l of o)if(l in s.children)s=s.children[l];else return null;return s}traverse(o){o.isLeaf&&this.suggestions.push(...o.value);for(const s in o.children)this.traverse(o.children[s])}complete(o,s=null){this.suggestions=[];const l=this.find(o.toLowerCase());if(!l||Object.keys(l).length===0)return this.suggestions;this.suggestions.push(...l.value);const w=l.children;let g=0;for(const b in w)if(this.traverse(w[b]),g++,s&&g===s)break;return this.suggestions}}const at=Object.keys(E);function H(t,o,s=0,l=0){if(t.selectionStart||t.selectionStart===0){const w=t.selectionStart,g=t.selectionEnd;t.value=t.value.substring(0,w-s)+o+t.value.substring(g,t.value.length);const b=+w-s+o.length-l;if(t.setSelectionRange)t.focus(),t.setSelectionRange(b,b);else if(t.createTextRange){const S=t.createTextRange();S.collapse(!0),S.moveEnd("character",b),S.moveStart("character",b),S.select()}}else t.value+=o;return t.value}function lt(t,o){const s=t.substring(0,o);if(s.indexOf(" ")>0){const l=s.split(" ");return l[l.length-1]}else return s}function it(t){const o=ut(t);return lt(t.value,o)||""}function ut(t){let o=0;return(t.selectionStart||t.selectionStart===0)&&(o=t.selectionStart),o}const P=t=>(Qe("data-v-50229832"),t=t(),He(),t),ct={class:"formula-wrapper relative"},pt={key:0,class:"absolute -left-91 w-84 top-0 bg-white z-10 pl-3 pt-3 border-1 shadow-md rounded-xl"},dt={class:"pr-3"},mt={class:"flex flex-row w-full justify-between pb-1 border-b-1"},ft={class:"flex items-center gap-x-1 font-semibold text-base"},vt={class:"flex flex-col max-h-120 nc-scrollbar-md pr-2"},gt={class:"flex mt-3"},_t=P(()=>c("div",{class:"text-gray-500 uppercase text-xs mt-3 mb-2"},"Syntax",-1)),ht={class:"bg-white rounded-md py-1 px-2 border-1"},xt=P(()=>c("div",{class:"text-gray-500 uppercase text-xs mt-3 mb-2"},"Examples",-1)),yt={class:"flex flex-row mt-1 mb-3 justify-end pr-3"},bt=["href"],wt=P(()=>c("div",{class:"rounded-t-lg border-1 bg-gray-50 px-3 py-1 uppercase text-gray-600 text-xs"},"Formulas",-1)),kt={class:"flex items-center gap-x-1"},Ct={class:"prose-sm text-gray-600"},St=P(()=>c("div",{class:"rounded-t-lg border-1 bg-gray-50 px-3 py-1 uppercase text-gray-600 text-xs"},"Fields",-1)),Tt={class:"flex items-center gap-x-1"},It={class:"prose-sm text-gray-600"},Ot={key:2},Lt=P(()=>c("span",{class:"text-gray-500"},"Empty",-1)),$t=[Lt],Rt=Ue({__name:"FormulaOptions",props:{value:{}},emits:["update:value"],setup(t,{emit:o}){var se,oe,re,ne,ae,le,ie;const s=t,l=o,w=[W.QrCode,W.Barcode],g=Me(s,"value",l),{setAdditionalValidations:b,validateInfos:S,sqlUi:J,column:T}=Je(),{t:me}=Ne();Xe();const I=Be(Re,_()),X=M(()=>{var r,e;return((e=(r=I==null?void 0:I.value)==null?void 0:r.columns)==null?void 0:e.filter(a=>!(w.includes(a.uidt)||je(a)&&a.system)))||[]}),{getMeta:fe}=Ye(),d=_(),ve={formula_raw:[{validator:(r,e)=>(async()=>{var a;if(!(e!=null&&e.trim()))throw new Error("Required");try{await We({column:T.value,formula:e,columns:X.value,clientOrSqlUi:J.value,getMeta:fe})}catch(m){throw m instanceof ze&&((a=m.extra)!=null&&a.key)?new Error(me(m.extra.key,m.extra)):new Error(m.message)}})()}]},ge=at,_e=["+","-","*","/",">","<","==","<=",">=","!=","&"],Y=_(!1),O=_(),he=_(),xe=_([]),V=_([]),A=_(""),i=_(0),Z={column:0,function:1,op:2},R=M(()=>{const r=J.value.getUnsupportedFnList();return[...ge.filter(e=>!r.includes(e)).map(e=>({text:`${e}()`,type:"function",description:E[e].description,syntax:E[e].syntax,examples:E[e].examples,docsUrl:E[e].docsUrl})),...X.value.filter(e=>{var a;return e.uidt===W.LinkToAnotherRecord&&e.system?!1:T?((a=T.value)==null?void 0:a.id)!==e.id:!0}).map(e=>({text:e.title,type:"column",icon:Ee(e.uidt),uidt:e.uidt})),..._e.map(e=>({text:e,type:"op"}))]}),u=_(R.value),ye=M(()=>{const r=new nt;for(const e of R.value)r.add(e);return r}),h=M(()=>u.value.filter(r=>r&&r.type!=="column")),F=M(()=>u.value.filter(r=>r&&r.type==="column"));function ee(){const r=(O.value.$el.value.match(/\{|}/g)||[]).reduce((e,a)=>(e[a]=(e[a]||0)+1,e),{});return(r["{"]||0)===(r["}"]||0)}function D(r){var m;const e=r.text,a=((m=A.value)==null?void 0:m.length)||0;r.type==="function"?g.value.formula_raw=H(O.value.$el,e,a,1):r.type==="column"?g.value.formula_raw=H(O.value.$el,`{${e}}`,a+ +!ee()):g.value.formula_raw=H(O.value.$el,e,a),Y.value=!1,A.value="",r.type==="function"||r.type==="op"?u.value=R.value.filter(U=>U.type==="column"):u.value=R.value}const be=Ge(function(){we()},250);function we(){var a;i.value=0,u.value=[];const e=it(O.value.$el).split(/\W+/);A.value=e.pop()||"",u.value=(a=ye.value.complete(A.value))==null?void 0:a.sort((m,U)=>Z[m.type]-Z[U.type]),u.value.length>0&&u.value[0].type!=="column"&&(d.value=u.value[0]),ee()||(u.value=u.value.filter(m=>m.type==="column")),Y.value=!!u.value.length}function ke(){u.value&&i.value>-1&&i.value<R.value.length&&(i.value<h.value.length?D(h.value[i.value]):D(F.value[i.value+h.value.length])),i.value=0}function Ce(){u.value&&(i.value=--i.value>-1?i.value:u.value.length-1,d.value=h.value[i.value],te())}function Se(){u.value&&(i.value=++i.value%u.value.length,d.value=h.value[i.value],te())}function te(){Ke(()=>{if(V.value[i.value])try{V.value[i.value].$el.scrollIntoView({block:"nearest",inline:"start"})}catch{}})}return(oe=(se=T.value)==null?void 0:se.colOptions)!=null&&oe.formula_raw&&(g.value.formula_raw=Pe((ne=(re=T.value)==null?void 0:re.colOptions)==null?void 0:ne.formula,(ae=I==null?void 0:I.value)==null?void 0:ae.columns,(ie=(le=T.value)==null?void 0:le.colOptions)==null?void 0:ie.formula_raw)||""),b({...ve}),Ve(()=>{Ae.plugins.register(De)}),(r,e)=>{const a=Le,m=$e,U=st,Te=ot,ue=Ze,ce=et,pe=tt;return f(),k("div",ct,[n(d)&&n(d).type==="function"?(f(),k("div",pt,[c("div",dt,[c("div",mt,[c("div",ft,[(f(),N(B(n(z).function),{class:"text-lg"})),de(" "+$(n(d).text),1)]),v(m,{type:"text",size:"small",onClick:e[0]||(e[0]=p=>d.value=void 0)},{default:y(()=>[v(a,{icon:"close"})]),_:1})])]),c("div",vt,[c("div",gt,$(n(d).description),1),_t,c("div",ht,$(n(d).syntax),1),xt,(f(!0),k(G,null,Fe(n(d).examples,(p,x)=>(f(),k("div",{key:p,class:K(["bg-gray-100 py-1 px-2",{"border-t-1 border-gray-200":x!==0,"rounded-b-md":x===n(d).examples.length-1&&n(d).examples.length!==1,"rounded-t-md":x===0&&n(d).examples.length!==1,"rounded-md":n(d).examples.length===1}])},$(p),3))),128))]),c("div",yt,[c("a",{target:"_blank",rel:"noopener noreferrer",href:n(d).docsUrl},[v(m,{type:"text",class:"!text-gray-400 !hover:text-gray-800 !text-xs"},{default:y(()=>[de("View in Docs "),v(a,{icon:"openInNew",class:"ml-1"})]),_:1})],8,bt)])])):C("",!0),v(Te,qe(n(S).formula_raw,{class:"!pb-1",label:r.$t("datatype.Formula")}),{default:y(()=>[v(U,{ref_key:"formulaRef",ref:O,value:n(g).formula_raw,"onUpdate:value":e[1]||(e[1]=p=>n(g).formula_raw=p),class:"nc-formula-input !rounded-md !my-1",onKeydown:[Q(j(Se,["prevent"]),["down"]),Q(j(Ce,["prevent"]),["up"]),Q(j(ke,["prevent"]),["enter"])],onChange:n(be)},null,8,["value","onKeydown","onChange"])]),_:1},16,["label"]),c("div",{ref_key:"sugListRef",ref:he,class:"h-[250px] overflow-auto nc-scrollbar-md"},[n(h).length>0?(f(),k(G,{key:0},[wt,v(pe,{"data-source":n(h),locale:{emptyText:r.$t("msg.formula.noSuggestedFormulaFound")},class:"border-1 border-t-0 rounded-b-lg !mb-4"},{renderItem:y(({item:p,index:x})=>[v(ce,{ref:L=>{n(V)[x]=L},class:K(["cursor-pointer !overflow-hidden hover:bg-gray-50",{"!bg-gray-100":n(i)===x}]),onClick:j(L=>D(p),["prevent","stop"]),onMouseenter:L=>d.value=p},{default:y(()=>[v(ue,null,{title:y(()=>[c("div",kt,[p.type==="function"?(f(),N(B(n(z).function),{key:0,class:"text-lg"})):C("",!0),p.type==="op"?(f(),N(B(n(z).calculator),{key:1,class:"text-lg"})):C("",!0),p.type==="column"?(f(),N(B(p.icon),{key:2,class:"text-lg"})):C("",!0),c("span",Ct,$(p.text),1)])]),_:2},1024)]),_:2},1032,["class","onClick","onMouseenter"])]),_:1},8,["data-source","locale"])],64)):C("",!0),n(F).length>0?(f(),k(G,{key:1},[St,v(pe,{ref_key:"variableListRef",ref:xe,"data-source":n(F),locale:{emptyText:r.$t("msg.formula.noSuggestedFormulaFound")},class:"border-1 border-t-0 rounded-b-lg !overflow-hidden"},{renderItem:y(({item:p,index:x})=>[v(ce,{ref:L=>{n(V)[x+n(h).length]=L},class:K([{"!bg-gray-100":n(i)===x+n(h).length},"cursor-pointer hover:bg-gray-50"]),onClick:j(L=>D(p),["prevent","stop"])},{default:y(()=>[v(ue,null,{title:y(()=>[c("div",Tt,[(f(),N(B(p.icon),{class:"text-lg"})),c("span",It,$(p.text),1)])]),_:2},1024)]),_:2},1032,["class","onClick"])]),_:1},8,["data-source","locale"])],64)):C("",!0),n(u).length===0?(f(),k("div",Ot,$t)):C("",!0)],512)])}}});const $s=rt(Rt,[["__scopeId","data-v-50229832"]]);export{$s as default};
