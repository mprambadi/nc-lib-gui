import{M as B,bF as E,r as I,g as P,O as h,X as T,eZ as k,eX as j,f8 as y,Y as _,C as F}from"./entry.96205fa0.js";import{d as X}from"./deepCompare.d32ec333.js";import{e as f}from"./dataUtils.fb0a3616.js";import{a as b,b as A,i as O}from"./virtualCell.9142cfee.js";import{a as G,b as H}from"./bases.965a49bb.js";import{u as Y}from"./index.e034edbd.js";const[V,Z]=Y((l,R)=>{const{$api:c}=F(),{t:g}=B(),{base:p}=E(G()),{metas:S}=H(),d=I(R),s=I({}),C=P(()=>h(R).rowMeta.new??!1),x=async(t,e)=>{if(b(e)||A(e)){if(s.value[e.title]||(s.value[e.title]=[]),s.value[e.title].find(o=>X(o,t)))return T.info(g("msg.info.valueAlreadyInList"));Array.isArray(t)?s.value[e.title].push(...t):s.value[e.title].push(t)}else O(e)&&(s.value[e.title]=t)},U=async(t,e)=>{var o,a;b(e)||A(e)?(a=s.value[e.title])==null||a.splice((o=s.value[e.title])==null?void 0:o.indexOf(t),1):O(e)&&(s.value[e.title]=null)},L=async(t,e,o,a,{metaValue:n=l.value}={})=>{try{await c.dbTableRow.nestedAdd(y,p.value.id,n==null?void 0:n.id,encodeURIComponent(t),a,o.id,encodeURIComponent(e))}catch(v){T.error(await _(v))}};return{row:R,state:s,isNew:C,addLTARRef:x,removeLTARRef:U,syncLTARRefs:async(t,{metaValue:e=l.value}={})=>{var a,n,v,w;const o=f(t,e==null?void 0:e.columns);for(const r of(e==null?void 0:e.columns)??[]){if(!k(r))continue;const i=r.colOptions,u=(a=S.value)==null?void 0:a[i==null?void 0:i.fk_related_model_id];if(b(r)||A(r)){const M=((n=s.value)==null?void 0:n[r.title])??[];for(const N of M)await L(o,f(N,u.columns),r,i.type,{metaValue:e})}else O(r)&&((v=s.value)!=null&&v[r.title])&&await L(o,f((w=s.value)==null?void 0:w[r.title],u.columns),r,i.type,{metaValue:e});s.value[r.title]=null}},loadRow:async()=>{var e,o,a,n;const t=await c.dbTableRow.read(y,(e=p.value)==null?void 0:e.id,(o=l.value)==null?void 0:o.title,encodeURIComponent(f((a=h(R))==null?void 0:a.row,(n=l.value)==null?void 0:n.columns)));Object.assign(h(R),{row:t,oldRow:{...t},rowMeta:{}})},currentRow:d,clearLTARCell:async t=>{var e,o,a,n,v,w,r;try{if(!t||!k(t))return;const i=(o=S.value)==null?void 0:o[(e=t==null?void 0:t.colOptions)==null?void 0:e.fk_related_model_id];if(C.value)s.value[t.title]=null;else if(d.value)if(((a=t.colOptions)==null?void 0:a.type)===j.BELONGS_TO){if(!d.value.row[t.title])return;await c.dbTableRow.nestedRemove(y,p.value.id,(n=l.value)==null?void 0:n.id,f(d.value.row,(v=l.value)==null?void 0:v.columns),"bt",t.id,f(d.value.row[t.title],i==null?void 0:i.columns)),d.value.row[t.title]=null}else{for(const u of d.value.row[t.title]||[])await c.dbTableRow.nestedRemove(y,p.value.id,(w=l.value)==null?void 0:w.id,encodeURIComponent(f(d.value.row,(r=l.value)==null?void 0:r.columns)),(t==null?void 0:t.colOptions).type,t.id,encodeURIComponent(f(u,i==null?void 0:i.columns)));d.value.row[t.title]=[]}}catch(i){T.error(await _(i))}}}},"smartsheet-row-store");function ee(){const l=Z();if(l==null)throw new Error("Please call `useSmartsheetRowStore` on the appropriate parent component");return l}export{ee as a,V as u};
