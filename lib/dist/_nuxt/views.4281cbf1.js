import{aL as M,u as $,r as p,bF as k,g as c,H as x,C as j}from"./entry.5958c07b.js";import{u as z,c as _,e as E}from"./bases.e6c8e3c4.js";import{u as G}from"./useSharedView.e8f68616.js";const U=M("viewsStore",()=>{const{$api:R}=j(),r=$(),n=p([]),i=r.currentRoute,L=z(),u=_(),{activeWorkspaceId:g}=k(E()),O=c(()=>n.value.filter(e=>e.workspaceId===g.value).splice(0,10)),m=p(new Map),d=c({get:()=>(u.activeTableId?m.value.get(u.activeTableId):[])??[],set:e=>{if(u.activeTableId){if(!e)return m.value.delete(u.activeTableId);m.value.set(u.activeTableId,e)}}}),q=p([]),N=p([]),b=p(!0),y=p(!0),S=c(()=>{var e;return(e=i.value.meta)==null?void 0:e.public}),{activeTable:V}=k(_()),f=c(()=>{var e,a,s;if(!((e=i.value.params.viewTitle)!=null&&e.length)){const t=((a=d.value)==null?void 0:a.find(v=>v.is_default))||((s=d.value)==null?void 0:s[0]);return t==null?void 0:t.id}return i.value.params.viewTitle}),D=c(()=>{var e,a;return!((e=i.value.params)!=null&&e.slugs)||((a=i.value.params.slugs)==null?void 0:a.length)===0?"view":i.value.params.slugs[0]==="webhook"?"webhook":i.value.params.slugs[0]==="field"?"field":i.value.params.slugs[0]==="api"?"api":i.value.params.slugs[0]==="relation"?"relation":"view"}),{sharedView:w}=G(),I=c({get(){if(w.value)return w.value;if(V.value&&f.value)return d.value.find(e=>e.id===f.value)??d.value.find(e=>e.title===f.value)},set(e){if(w.value){w.value=e;return}if(!V.value||!e)return;const a=d.value.findIndex(s=>s.id===f.value)??d.value.findIndex(s=>s.title===f.value);a!==-1&&(d.value[a]=e)}}),B=c(()=>{var e;return((e=I.value)==null?void 0:e.lock_type)==="locked"}),F=p(!0),h=async({tableId:e,ignoreLoading:a,force:s}={})=>{if(e=e??u.activeTableId,e){if(!s&&m.value.get(e))return;a||(b.value=!0);const t=(await R.dbView.list(e)).list;t&&m.value.set(e,t.sort((v,o)=>v.order-o.order)),a||(b.value=!1)}},A=e=>{r.push({name:"index-typeOrId-baseId-index-index-viewId-viewTitle-slugs",params:{typeOrId:i.value.params.typeOrId,baseId:i.value.params.baseId,viewId:i.value.params.viewId,viewTitle:f.value,slugs:[e]}})},C=async({viewId:e,tableId:a,baseId:s})=>{const t="index-typeOrId-baseId-index-index-viewId-viewTitle";await r.push({name:t,params:{viewTitle:e||"",viewId:a,baseId:s}})},P=({viewId:e,tableId:a,baseId:s})=>{s&&!e&&!a?n.value=n.value.filter(t=>t.baseId!==s):s&&a&&!e?n.value=n.value.filter(t=>t.baseId!==s||t.tableID!==a):a&&e&&(n.value=n.value.filter(t=>t.viewId!==e||t.tableID!==a))};x(()=>u.activeTableId,async(e,a)=>{if(e!==a){if(S.value){b.value=!1;return}y.value=!0;try{u.activeTable&&(u.activeTable.isViewsLoading=!0),await h()}catch(s){console.error(s)}finally{u.activeTable&&(u.activeTable.isViewsLoading=!1)}}},{immediate:!0});const W=c(()=>{var e;return((e=I.value)==null?void 0:e.lock_type)==="locked"}),H=async({view:e,baseId:a,tableId:s,hardReload:t,doNotSwitchTab:v})=>{const o="index-typeOrId-baseId-index-index-viewId-viewTitle-slugs";let l=a;["base"].includes(i.value.params.typeOrId)&&(l=i.value.params.baseId);const T=v?r.currentRoute.value.params.slugs:void 0;r.currentRoute.value.query&&r.currentRoute.value.query.page&&r.currentRoute.value.query.page==="fields"?await r.push({name:o,params:{viewTitle:e.id||"",viewId:s,baseId:l,slugs:T},query:r.currentRoute.value.query}):await r.push({name:o,params:{viewTitle:e.id||"",viewId:s,baseId:l,slugs:T}}),t&&await r.replace({name:o,query:{reload:"true"},params:{viewId:s,baseId:l,viewTitle:e.id||"",slugs:T}}).then(()=>{r.replace({name:o,query:{},params:{viewId:s,viewTitle:e.id||"",baseId:l,slugs:T}})})};return x(I,e=>{var t,v,o;if(!e||!e.base_id)return;const a=(v=(t=u.baseTables.get(e.base_id))==null?void 0:t.find(l=>l.id===e.fk_model_id))==null?void 0:v.title,s=(o=L.basesList.find(l=>l.id===e.base_id))==null?void 0:o.title;n.value=[{viewId:e.id,baseId:e.base_id,tableID:e.fk_model_id,isDefault:!!e.is_default,viewName:e.is_default?a:e.title,viewType:e.type,workspaceId:g.value,baseName:s},...n.value.filter(l=>l.viewId!==e.id||l.tableID!==e.fk_model_id)]}),{isLockedView:W,isViewsLoading:b,isViewDataLoading:y,isPaginationLoading:F,loadViews:h,recentViews:O,allRecentViews:n,views:d,activeView:I,openedViewsTab:D,onViewsTabChange:A,sharedView:w,viewsByTable:m,activeViewTitleOrId:f,navigateToView:H,changeView:C,removeFromRecentViews:P,activeSorts:q,activeNestedFilters:N,isActiveViewLocked:B}});export{U as u};
