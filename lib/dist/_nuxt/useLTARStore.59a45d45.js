import{A as ge,S as me,b as we}from"./index.9b87fcff.js";import{b as Le,a as $e,f as be,p as ve}from"./bases.e6c8e3c4.js";import{bF as ke,bb as W,r as d,N as Z,M as Re,g as c,cG as M,gn as Ie,go as de,cx as Te,H as x,u as _e,f8 as E,X as z,Y as A,ah as Pe,C as qe}from"./entry.5958c07b.js";import{u as Ee}from"./index.e61e381a.js";import{u as ze}from"./useSharedView.e8f68616.js";const[Fe,Se]=Ee((l,g,I,p=S=>{})=>{var ie,ue,re;const{metas:S,getMeta:fe}=Le(),{base:T}=ke($e()),{$api:y,$e:B}=qe(),N=W(ge,d()),{addUndo:D,clone:C,defineViewScope:ee}=be(),ae=W(me,d(null)),h=d(),m=d(),n=Z({page:1,query:"",size:10}),v=Z({page:1,query:"",size:10}),G=d(!1),w=d([]),U=d([]),_=d([]),H=d(!1),L=d([]),te=Z({state:null}),P=d(0),{t:j}=Re(),se=W(we,d(!1)),f=c(()=>{var a;return(a=l.value)==null?void 0:a.colOptions}),{sharedView:K}=ze(),X=((ie=T.value)==null?void 0:ie.id)||((re=(ue=K.value)==null?void 0:ue.view)==null?void 0:re.base_id),$=c(()=>{var a,e;return(e=S==null?void 0:S.value)==null?void 0:e[(a=l==null?void 0:l.value)==null?void 0:a.fk_model_id]}),r=c(()=>{var a,e;return(e=S.value)==null?void 0:e[(a=f.value)==null?void 0:a.fk_related_model_id]}),b=c(()=>$.value.columns.filter(a=>a.pk).map(a=>{var e,s;return(s=(e=g==null?void 0:g.value)==null?void 0:e.row)==null?void 0:s[a.title]}).join("___")),F=a=>{var e,s;return(s=(e=r.value)==null?void 0:e.columns)==null?void 0:s.filter(t=>t.pk).map(t=>a==null?void 0:a[t.title]).join("___")},pe=async()=>{await fe(f.value.fk_related_model_id)},k=c(()=>{var a,e,s,t,u;return((u=((e=(a=r.value)==null?void 0:a.columns)==null?void 0:e.find(i=>i.pv))||((t=(s=r==null?void 0:r.value)==null?void 0:s.columns)==null?void 0:t[0]))==null?void 0:u.title)||""}),ce=c(()=>{var a,e,s;return((s=(e=(a=r.value)==null?void 0:a.columns)==null?void 0:e.filter(t=>t.pk))==null?void 0:s.map(t=>t.title))??[]}),O=c(()=>{var a,e,s,t,u;return(u=((e=(a=$.value)==null?void 0:a.columns)==null?void 0:e.find(i=>i.pv))||((t=(s=r==null?void 0:r.value)==null?void 0:s.columns)==null?void 0:t[0]))==null?void 0:u.title}),V=c(()=>{var s,t,u,i,o,q;let a={type:"",format:""};const e=((t=(s=r.value)==null?void 0:s.columns)==null?void 0:t.find(R=>R.pv))||((i=(u=r==null?void 0:r.value)==null?void 0:u.columns)==null?void 0:i[0]);return e&&((e==null?void 0:e.uidt)===M.DateTime&&(a={type:e==null?void 0:e.uidt,format:`${((o=ve(e==null?void 0:e.meta))==null?void 0:o.date_format)??Ie[0]} ${((q=ve(e==null?void 0:e.meta))==null?void 0:q.time_format)??de[0]}`}),(e==null?void 0:e.uidt)===M.Time&&(a={type:e==null?void 0:e.uidt,format:`${de[0]}`})),a}),ye=c(()=>g.value.row[O.value]&&V.value.type&&V.value.format?Te(g.value.row[O.value],V.value.format,V.value.format!==M.Time):g.value.row[O.value]),le=async a=>{var e,s,t,u;a&&(te.state=a);try{if(H.value=!0,se.value){const o=_e().currentRoute;h.value=await y.public.dataRelationList(o.value.params.viewId,l.value.id,{},{headers:{"xc-password":ae.value},query:{limit:n.size,offset:n.size*(n.page-1),where:n.query&&`(${k.value},like,${n.query})`,fields:[k.value,...ce.value]}})}else I!=null&&I.value?h.value=await y.dbTableRow.list(E,X,(e=r==null?void 0:r.value)==null?void 0:e.id,{limit:n.size,offset:n.size*(n.page-1),where:n.query&&`(${k.value},like,${n.query})`}):h.value=await y.dbTableRow.nestedChildrenExcludedList(E,X,$.value.id,encodeURIComponent(b.value),f.value.type,(s=l==null?void 0:l.value)==null?void 0:s.id,{limit:String(n.size),offset:String(n.size*(n.page-1)),where:n.query&&`(${k.value},like,${n.query})`});(t=h.value)==null||t.list.forEach((i,o)=>{L.value[o]=!1,_.value[o]=!1}),(u=h.value)!=null&&u.list&&a&&a[l.value.title]&&h.value.list.forEach((i,o)=>{a[l.value.title].find(R=>{let oe=!0;for(const ne in R)R[ne]!==i[ne]&&(oe=!1);return oe})&&(L.value[o]=!0)})}catch(i){z.error(`${j("msg.error.failedToLoadList")}: ${await A(i)}`)}finally{H.value=!1}},Y=async()=>{var a,e,s,t,u,i,o;try{if(G.value=!0,f.value.type==="bt"||!b.value||!l.value)return;se.value?m.value=await y.public.dataNestedList((a=K.value)==null?void 0:a.uuid,encodeURIComponent(b.value),f.value.type,l.value.id,{limit:String(v.size),offset:String(v.size*(v.page-1)),where:v.query&&`(${k.value},like,${v.query})`},{headers:{"xc-password":ae.value}}):m.value=await y.dbTableRow.nestedList(E,((e=T==null?void 0:T.value)==null?void 0:e.id)||((t=(s=K.value)==null?void 0:s.view)==null?void 0:t.base_id),$.value.id,encodeURIComponent(b.value),f.value.type,(u=l==null?void 0:l.value)==null?void 0:u.id,{limit:String(v.size),offset:String(v.size*(v.page-1)),where:v.query&&`(${k.value},like,${v.query})`}),(i=m.value)==null||i.list.forEach((q,R)=>{U.value[R]=!0,w.value[R]=!1}),v.query||(P.value=((o=m.value)==null?void 0:o.pageInfo.totalRows)??0)}catch(q){z.error(`${j("msg.error.failedToLoadChildrenList")}: ${await A(q)}`)}finally{G.value=!1}},he=async(a,e)=>{Pe.confirm({title:"Do you want to delete the record?",type:"warning",onOk:async()=>{const s=F(a);try{const t=await y.dbTableRow.delete(E,X,r.value.id,encodeURIComponent(s));if(t.message)return z.info(`Record delete failed: ${`Unable to delete record with ID ${s} because of the following:
              
${t.message.join(`
`)}.

              Clear the data first & try again`})}`),!1;p==null||p(!1),I!=null&&I.value||await Y(),e==null||e(a),B("a:links:delete-related-row")}catch(t){z.error(`${j("msg.error.deleteFailed")}: ${await A(t)}`)}}})},J=async(a,{metaValue:e=$.value}={},s=!1,t)=>{var u;try{_.value[t]=!0,w.value[t]=!0,await y.dbTableRow.nestedRemove(E,T.value.id,e.id,encodeURIComponent(b.value),f.value.type,(u=l==null?void 0:l.value)==null?void 0:u.id,encodeURIComponent(F(a))),s||D({redo:{fn:i=>J(i,{},!0,t),args:[C(a)]},undo:{fn:i=>Q(i,{},!0,t),args:[C(a)]},scope:ee({view:N.value})}),L.value[t]=!1,U.value[t]=!1,f.value.type!=="bt"&&(P.value=P.value-1)}catch(i){z.error(`${j("msg.error.unlinkFailed")}: ${await A(i)}`)}finally{setTimeout(()=>{_.value[t]=!1,w.value[t]=!1},600)}p==null||p(!1),B("a:links:unlink")},Q=async(a,{metaValue:e=$.value}={},s=!1,t)=>{var u,i;try{_.value[t]=!0,w.value[t]=!0,await y.dbTableRow.nestedAdd(E,T.value.id,e.id,encodeURIComponent(b.value),f.value.type,(u=l==null?void 0:l.value)==null?void 0:u.id,encodeURIComponent(F(a))),s||D({redo:{fn:o=>Q(o,{},!0,t),args:[C(a)]},undo:{fn:o=>J(o,{},!0,t),args:[C(a)]},scope:ee({view:N.value})}),L.value[t]=!0,U.value[t]=!0,f.value.type!=="bt"?P.value=P.value+1:(L.value=Array((i=h.value)==null?void 0:i.list.length).fill(!1),L.value[t]=!0)}catch(o){z.error(`Linking failed: ${await A(o)}`)}finally{setTimeout(()=>{_.value[t]=!1,w.value[t]=!1},600)}p==null||p(!1),B("a:links:link")};return x(n,async()=>{await le(te.state)}),x(v,async()=>{await Y()}),x(m,async()=>{var a;(a=m.value)==null||a.list.forEach((e,s)=>{U.value[s]=!0,w.value[s]=!1})}),{relatedTableMeta:r,loadRelatedTableMeta:pe,relatedTableDisplayValueProp:k,displayValueTypeAndFormatProp:V,childrenExcludedList:h,childrenList:m,childrenListCount:P,rowId:b,childrenExcludedListPagination:n,childrenListPagination:v,displayValueProp:O,meta:$,unlink:J,link:Q,loadChildrenExcludedList:le,loadChildrenList:Y,isChildrenExcludedListLinked:L,isChildrenListLinked:U,isChildrenListLoading:w,isChildrenExcludedListLoading:_,row:g,isChildrenLoading:G,isChildrenExcludedLoading:H,deleteRelatedRow:he,getRelatedTableRowId:F,headerDisplayValue:ye}},"ltar-store");function Oe(){const l=Se();if(l==null)throw new Error("Please call `useLTARStore` on the appropriate parent component");return l}export{Oe as a,Fe as u};
