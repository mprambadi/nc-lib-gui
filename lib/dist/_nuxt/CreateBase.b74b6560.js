import{_ as ke}from"./_plugin-vue_export-helper.c27b6911.js";import{o as c,c as h,f as He,a5 as Xe,g as O,bE as f,bF as Ze,bb as et,r as _,L as tt,M as at,g9 as te,ga as S,gb as nt,H as ae,i as ot,a7 as lt,P as b,w as s,a as i,d as $,t as p,b as l,O as t,ae as k,U as N,V,Q as L,R as F,T as x,cb as st,gc as ne,W as R,d1 as _e,X as z,Y as Se,gd as it,af as ct,ah as rt,p as ut,e as dt,C as ye}from"./entry.5958c07b.js";import{_ as pt}from"./Button.vue.c3ca0e8f.js";import{_ as mt}from"./Icon.vue.129448d5.js";import{_ as ft}from"./Editor.vue.dc99355a.js";import{_ as vt}from"./Modal.vue.ee5af191.js";import{a as bt,u as _t,c as St,d as yt}from"./bases.e6c8e3c4.js";import{f as v,d as gt,g as kt}from"./validation.2de04583.js";import{k as Ct}from"./index.9b87fcff.js";import{g as wt}from"./AirtableImport.vue.788302cf.js";import{r as $t}from"./fileUtils.43128440.js";import{F as ge}from"./index.b06c8b67.js";import"./index.ae235b22.js";import{I as ht}from"./Input.dca3a2bc.js";import{C as Ut}from"./index.f98c1d80.js";import{_ as xt,C as Tt}from"./index.0c7dde5a.js";import{_ as Pt}from"./FormItem.0bbf90a3.js";import{S as It,_ as Nt}from"./index.5c6e4286.js";import{_ as Lt}from"./index.97da8ac6.js";import{_ as Ft}from"./Password.f52125e7.js";import{_ as jt}from"./index.07078df6.js";import"./index.55641318.js";import"./debounce.7c24f171.js";import"./toNumber.e09cd85a.js";import"./isSymbol.114fe557.js";import"./deepCompare.d32ec333.js";import"./workerUtils.cf9cb0a4.js";import"./index.0feaca99.js";import"./index.44969945.js";import"./CheckOutlined.1fe5f230.js";import"./useRefs.40c81887.js";import"./useState.b891c8bb.js";import"./FormItemContext.ddc65fa5.js";import"./index.912f77e8.js";import"./Dropdown.041b2468.js";import"./identity.34c7640e.js";import"./_flatRest.39582a58.js";import"./isMobile.e2e89480.js";import"./index.5e1434a7.js";import"./Checkbox.2e7b0035.js";import"./createForOfIteratorHelper.33de41ba.js";import"./Modal.vue.0f13e4cb.js";import"./views.4281cbf1.js";import"./useSharedView.e8f68616.js";import"./tab.09fe72b2.js";import"./index.357e1bba.js";import"./Col.a97e3e76.js";import"./responsiveObserve.0baefba6.js";import"./useSize.fad35fe8.js";import"./isPlainObject.ccda79fe.js";import"./_getPrototype.c1f3bae2.js";import"./SearchOutlined.a517903c.js";import"./TextArea.9074ff05.js";import"./antInputDirective.8ac36ea7.js";import"./RightOutlined.7161c742.js";import"./toArray.fd74ce6f.js";import"./useMemo.1dd071d8.js";const Et={};function Mt(T,oe){return c(),h("span")}const Ot=ke(Et,[["render",Mt]]),Ce=T=>(ut("data-v-4b2fbe9e"),T=T(),dt(),T),Vt={class:"py-6 px-8"},zt={class:"create-source bg-white relative flex flex-col justify-center gap-2 w-full"},Bt={class:"prose-xl font-bold self-start mb-4 flex items-center gap-2"},Dt=Ce(()=>i("span",{class:"flex-grow"},null,-1)),Rt={class:"nc-scrollbar-md",style:{maxHeight:"60vh"}},At={class:"flex items-center gap-2 justify-between"},Qt={class:"flex items-right justify-end gap-2"},qt={class:"flex items-center gap-2 justify-between"},Gt={class:"flex gap-2"},Jt={class:"flex py-1 items-center gap-1"},Kt=Ce(()=>i("span",null,":",-1)),Yt={class:"flex items-center justify-center"},Wt={class:"flex items-center gap-2 justify-between"},Ht={class:"flex items-center gap-2 justify-between"},Xt={class:"flex justify-end"},Zt={class:"flex justify-end gap-2"},ea=He({__name:"CreateBase",props:{open:{type:Boolean},connectionType:{}},emits:["update:open","sourceCreated"],setup(T,{emit:oe}){const le=T,se=oe,A=Xe(le,"open",se),we=O(()=>le.connectionType??f.MYSQL),$e=bt(),{loadProject:he}=_t(),{base:Ue}=Ze($e),{loadProjectTables:xe}=St(),{refreshCommandPalette:Te}=yt(),Q=et(Ct,void 0),j=O(()=>{var e;return(Q==null?void 0:Q.value)??((e=Ue.value)==null?void 0:e.id)}),Pe=ge.useForm,C=_(!1),q=_(!1),G=_(),{api:J}=tt(),{$e:ie}=ye(),{t:K}=at(),U=_(!1),a=_({title:"",dataSource:{...te(f.MYSQL)},inflection:{inflectionColumn:"none",inflectionTable:"none"},sslUse:S.No,extraParameters:[]}),E=_({title:"",dataSource:{...te(f.MYSQL)},inflection:{inflectionColumn:"none",inflectionTable:"none"},sslUse:S.No,extraParameters:[]}),Ie=O(()=>nt.filter(e=>e.value!==f.SNOWFLAKE)),Ne=O(()=>{let e={"dataSource.connection.host":[v()],"dataSource.connection.port":[v()],"dataSource.connection.user":[v()],"dataSource.connection.password":[v()],"dataSource.connection.database":[v()]};switch(a.value.dataSource.client){case f.SQLITE:e={"dataSource.connection.connection.filename":[v()]};break;case f.SNOWFLAKE:e={"dataSource.connection.account":[v()],"dataSource.connection.username":[v()],"dataSource.connection.password":[v()],"dataSource.connection.warehouse":[v()],"dataSource.connection.database":[v()],"dataSource.connection.schema":[v()]};break;case f.PG:case f.MSSQL:e["dataSource.searchPath.0"]=[v()];break}return{title:[{required:!0,message:K("labels.sourceNameRequired")},gt],extraParameters:[kt],"dataSource.client":[v()],...e}}),{validate:ce,validateInfos:g}=Pe(a.value,Ne),re=e=>{a.value.dataSource.connection.database=`${e.trim()}_noco`},ue=()=>{a.value.dataSource={...te(a.value.dataSource.client)},re(a.value.title)},Le=e=>{if(a.value.dataSource.client!==f.SQLITE){const n=a.value.dataSource.connection;switch(e){case S.No:delete n.ssl;break;case S.Allowed:n.ssl="true";break;default:n.ssl={ca:"",cert:"",key:""};break}}},de=()=>{if(a.value.dataSource.client!==f.SQLITE){const e=a.value.dataSource.connection;e.ssl?typeof e.ssl=="string"?a.value.sslUse=S.Allowed:a.value.sslUse=S.Preferred:a.value.sslUse=S.No}},Fe=()=>{a.value.extraParameters.push({key:"",value:""})},je=e=>{a.value.extraParameters.splice(e,1)},pe=["camelize","none"],P=_(""),I=_(!1),M=_(!1),Y=_(),W=_(),H=_(),X=(e,n)=>{n&&$t(n,r=>{"ssl"in a.value.dataSource.connection&&typeof a.value.dataSource.connection.ssl=="object"&&(a.value.dataSource.connection.ssl[e]=r??"")})},Z=O(()=>!!a.value.sslUse&&a.value.sslUse!==S.No&&a.value.sslUse!==S.Allowed);function me(){const e=Object.fromEntries(new Map(a.value.extraParameters.map(r=>[r.key,r.value]))),n={...a.value.dataSource.connection,...e};return"ssl"in n&&n.ssl&&(a.value.sslUse===S.No||typeof n.ssl=="object"&&Object.values(n.ssl).every(r=>r==null))&&delete n.ssl,n}const fe=()=>{var e,n,r,m,d;(d=(m=(r=(n=(e=G.value)==null?void 0:e.$el.querySelector(".ant-form-item-explain-error"))==null?void 0:n.parentNode)==null?void 0:r.parentNode)==null?void 0:m.querySelector("input"))==null||d.focus()},{$poller:Ee}=ye(),Me=async()=>{try{await ce()}catch{fe();return}try{if(!j.value)return;U.value=!0;const e=me(),n={...a.value.dataSource,connection:e},r=await J.source.create(j.value,{alias:a.value.title,type:a.value.dataSource.client,config:n,inflection_column:a.value.inflection.inflectionColumn,inflection_table:a.value.inflection.inflectionTable});Ee.subscribe({id:r.id},async m=>{m.status!=="close"&&(m.status===_e.COMPLETED?(ie("a:base:create:extdb"),j.value&&(await he(j.value,!0),await xe(j.value,!0)),se("sourceCreated"),A.value=!1,U.value=!1):status===_e.FAILED&&(z.error("Failed to create base"),U.value=!1))})}catch(e){z.error(await Se(e)),U.value=!1}finally{Te()}},Oe=async()=>{try{await ce()}catch{fe();return}ie("a:source:create:extdb:test-connection",[]);try{if(q.value=!0,a.value.dataSource.client===f.SQLITE)C.value=!0;else{const e=me();e.database=it(a.value.dataSource);const n={...a.value.dataSource,connection:e},r=await J.utils.testConnection(n);r.code===0?C.value=!0:(C.value=!1,z.error(`${K("msg.error.dbConnectionFailed")} ${r.message}`))}}catch(e){C.value=!1,z.error(await Se(e))}q.value=!1},Ve=async()=>{if(!P.value||P.value==="")return;const e=await J.utils.urlToConfig({url:P.value});e?(a.value.dataSource.client=e.client,a.value.dataSource.connection={...e.connection}):z.error(K("msg.error.invalidURL")),M.value=!1,de()},ze=()=>{E.value={...a.value},I.value=!0},Be=()=>{a.value={...E.value},I.value=!1,de()};ae(()=>a.value.dataSource,()=>C.value=!1,{deep:!0}),ae(()=>a.value.title,e=>re(e)),ot(async()=>{a.value.title=await wt(),lt(()=>{setTimeout(()=>{var n,r;const e=(r=(n=G.value)==null?void 0:n.$el)==null?void 0:r.querySelector("input[type=text]");e==null||e.setSelectionRange(0,a.value.title.length),e==null||e.focus()},500)})}),ae(we,e=>{a.value.dataSource.client=e,ue()},{immediate:!0});const De=e=>{A.value=e};return(e,n)=>{const r=Ot,m=ht,d=Pt,B=It,D=Nt,Re=Lt,Ae=Ft,w=pt,ee=ct,ve=jt,Qe=Ut,qe=xt,Ge=Tt,Je=mt,Ke=ge,Ye=ft,be=rt,We=vt;return c(),b(We,{visible:t(A),closable:!t(U),keyboard:!t(U),"mask-closable":!1,size:"medium","onUpdate:visible":De},{default:s(()=>[i("div",Vt,[i("div",zt,[i("h1",Bt,[$(p(e.$t("title.newBase"))+" ",1),l(r),Dt]),l(Ke,{ref_key:"form",ref:G,model:t(a),name:"external-base-create-form",layout:"horizontal","no-style":"","label-col":{span:8}},{default:s(()=>[i("div",Rt,[l(d,k({label:"Source Name"},t(g).title),{default:s(()=>[l(m,{value:t(a).title,"onUpdate:value":n[0]||(n[0]=o=>t(a).title=o),class:"nc-extdb-proj-name"},null,8,["value"])]),_:1},16),l(d,k({label:e.$t("labels.dbType")},t(g)["dataSource.client"]),{default:s(()=>[l(D,{value:t(a).dataSource.client,"onUpdate:value":n[1]||(n[1]=o=>t(a).dataSource.client=o),class:"nc-extdb-db-type","dropdown-class-name":"nc-dropdown-ext-db-type",onChange:ue},{default:s(()=>[(c(!0),h(N,null,V(t(Ie),o=>(c(),b(B,{key:o.value,value:o.value},{default:s(()=>[i("div",At,[i("div",null,p(o.text),1),t(a).dataSource.client===o.value?(c(),b(L(t(F).check),{key:0,id:"nc-selected-item-icon",class:"text-primary w-4 h-4"})):x("",!0)])]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1},16,["label"]),t(a).dataSource.client===t(f).SQLITE?(c(),b(d,k({key:0,label:e.$t("labels.sqliteFile")},t(g)["dataSource.connection.connection.filename"]),{default:s(()=>[l(m,{value:t(a).dataSource.connection.connection.filename,"onUpdate:value":n[2]||(n[2]=o=>t(a).dataSource.connection.connection.filename=o)},null,8,["value"])]),_:1},16,["label"])):(c(),h(N,{key:1},[l(d,k({label:e.$t("labels.hostAddress")},t(g)["dataSource.connection.host"]),{default:s(()=>[l(m,{value:t(a).dataSource.connection.host,"onUpdate:value":n[3]||(n[3]=o=>t(a).dataSource.connection.host=o),class:"nc-extdb-host-address"},null,8,["value"])]),_:1},16,["label"]),l(d,k({label:e.$t("labels.port")},t(g)["dataSource.connection.port"]),{default:s(()=>[l(Re,{value:t(a).dataSource.connection.port,"onUpdate:value":n[4]||(n[4]=o=>t(a).dataSource.connection.port=o),class:"!w-full nc-extdb-host-port"},null,8,["value"])]),_:1},16,["label"]),l(d,k({label:e.$t("labels.username")},t(g)["dataSource.connection.user"]),{default:s(()=>[l(m,{value:t(a).dataSource.connection.user,"onUpdate:value":n[5]||(n[5]=o=>t(a).dataSource.connection.user=o),class:"nc-extdb-host-user"},null,8,["value"])]),_:1},16,["label"]),l(d,{label:e.$t("labels.password")},{default:s(()=>[l(Ae,{value:t(a).dataSource.connection.password,"onUpdate:value":n[6]||(n[6]=o=>t(a).dataSource.connection.password=o),class:"nc-extdb-host-password"},null,8,["value"])]),_:1},8,["label"]),l(d,k({label:e.$t("labels.database")},t(g)["dataSource.connection.database"]),{default:s(()=>[l(m,{value:t(a).dataSource.connection.database,"onUpdate:value":n[7]||(n[7]=o=>t(a).dataSource.connection.database=o),placeholder:e.$t("labels.dbCreateIfNotExists"),class:"nc-extdb-host-database"},null,8,["value","placeholder"])]),_:1},16,["label"]),[t(f).MSSQL,t(f).PG].includes(t(a).dataSource.client)&&t(a).dataSource.searchPath?(c(),b(d,k({key:0,label:e.$t("labels.schemaName")},t(g)["dataSource.searchPath.0"]),{default:s(()=>[l(m,{value:t(a).dataSource.searchPath[0],"onUpdate:value":n[8]||(n[8]=o=>t(a).dataSource.searchPath[0]=o)},null,8,["value"])]),_:1},16,["label"])):x("",!0),i("div",Qt,[l(w,{type:"ghost",size:"small",class:"nc-extdb-btn-import-url !rounded-md",onClick:n[9]||(n[9]=st(o=>M.value=!0,["stop"]))},{default:s(()=>[$(p(e.$t("activity.useConnectionUrl")),1)]),_:1})]),l(Ge,{ghost:"","expand-icon-position":"right",class:"!mt-6"},{default:s(()=>[l(qe,{key:"1"},{header:s(()=>[i("span",null,p(e.$t("title.advancedParameters")),1)]),default:s(()=>[l(d,{label:"SSL mode"},{default:s(()=>[l(D,{value:t(a).sslUse,"onUpdate:value":n[10]||(n[10]=o=>t(a).sslUse=o),"dropdown-class-name":"nc-dropdown-ssl-mode",onSelect:Le},{default:s(()=>[(c(!0),h(N,null,V(Object.values(t(S)),o=>(c(),b(B,{key:o,value:o},{default:s(()=>{var u;return[i("div",qt,[i("div",null,p(o),1),((u=t(a))==null?void 0:u.sslUse)===o?(c(),b(L(t(F).check),{key:0,id:"nc-selected-item-icon",class:"text-primary w-4 h-4"})):x("",!0)])]}),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),l(d,{label:"SSL keys"},{default:s(()=>[i("div",Gt,[l(ee,{placement:"top"},{title:s(()=>[i("span",null,p(e.$t("tooltip.clientCert")),1)]),default:s(()=>[l(w,{size:"small",disabled:!t(Z),class:"shadow",onClick:n[11]||(n[11]=o=>{var u;return(u=t(H))==null?void 0:u.click()})},{default:s(()=>[$(p(e.$t("labels.clientCert")),1)]),_:1},8,["disabled"])]),_:1}),l(ee,{placement:"top"},{title:s(()=>[i("span",null,p(e.$t("tooltip.clientKey")),1)]),default:s(()=>[l(w,{size:"small",disabled:!t(Z),class:"shadow",onClick:n[12]||(n[12]=o=>{var u;return(u=t(W))==null?void 0:u.click()})},{default:s(()=>[$(p(e.$t("labels.clientKey")),1)]),_:1},8,["disabled"])]),_:1}),l(ee,{placement:"top"},{title:s(()=>[i("span",null,p(e.$t("tooltip.clientCA")),1)]),default:s(()=>[l(w,{size:"small",disabled:!t(Z),class:"shadow",onClick:n[13]||(n[13]=o=>{var u;return(u=t(Y))==null?void 0:u.click()})},{default:s(()=>[$(p(e.$t("labels.serverCA")),1)]),_:1},8,["disabled"])]),_:1})])]),_:1}),i("input",{ref_key:"caFileInput",ref:Y,type:"file",class:"!hidden",onChange:n[14]||(n[14]=o=>X(t(ne).ca,t(Y)))},null,544),i("input",{ref_key:"certFileInput",ref:H,type:"file",class:"!hidden",onChange:n[15]||(n[15]=o=>X(t(ne).cert,t(H)))},null,544),i("input",{ref_key:"keyFileInput",ref:W,type:"file",class:"!hidden",onChange:n[16]||(n[16]=o=>X(t(ne).key,t(W)))},null,544),l(ve),l(d,k({class:"mb-2",label:e.$t("labels.extraConnectionParameters")},t(g).extraParameters),{default:s(()=>[l(Qe,null,{default:s(()=>[(c(!0),h(N,null,V(t(a).extraParameters,(o,u)=>(c(),h("div",{key:u},[i("div",Jt,[l(m,{value:o.key,"onUpdate:value":y=>o.key=y},null,8,["value","onUpdate:value"]),Kt,l(m,{value:o.value,"onUpdate:value":y=>o.value=y},null,8,["value","onUpdate:value"]),(c(),b(L(t(F).close),{style:{"font-size":"1.5em",color:"red"},onClick:y=>je(u)},null,8,["onClick"]))])]))),128)),l(w,{size:"small",type:"dashed",class:"w-full caption mt-2",onClick:Fe},{default:s(()=>[i("div",Yt,[(c(),b(L(t(F).plus)))])]),_:1})]),_:1})]),_:1},16,["label"]),l(ve),l(d,{label:e.$t("labels.inflection.tableName")},{default:s(()=>[l(D,{value:t(a).inflection.inflectionTable,"onUpdate:value":n[17]||(n[17]=o=>t(a).inflection.inflectionTable=o),"dropdown-class-name":"nc-dropdown-inflection-table-name"},{default:s(()=>[(c(),h(N,null,V(pe,o=>l(B,{key:o,value:o},{default:s(()=>{var u,y;return[i("div",Wt,[i("div",null,p(o),1),((y=(u=t(a))==null?void 0:u.inflection)==null?void 0:y.inflectionTable)===o?(c(),b(L(t(F).check),{key:0,id:"nc-selected-item-icon",class:"text-primary w-4 h-4"})):x("",!0)])]}),_:2},1032,["value"])),64))]),_:1},8,["value"])]),_:1},8,["label"]),l(d,{label:e.$t("labels.inflection.columnName")},{default:s(()=>[l(D,{value:t(a).inflection.inflectionColumn,"onUpdate:value":n[18]||(n[18]=o=>t(a).inflection.inflectionColumn=o),"dropdown-class-name":"nc-dropdown-inflection-column-name"},{default:s(()=>[(c(),h(N,null,V(pe,o=>l(B,{key:o,value:o},{default:s(()=>{var u,y;return[i("div",Ht,[i("div",null,p(o),1),((y=(u=t(a))==null?void 0:u.inflection)==null?void 0:y.inflectionColumn)===o?(c(),b(L(t(F).check),{key:0,id:"nc-selected-item-icon",class:"text-primary w-4 h-4"})):x("",!0)])]}),_:2},1032,["value"])),64))]),_:1},8,["value"])]),_:1},8,["label"]),i("div",Xt,[l(w,{type:"primary",size:"small",class:"!rounded-md",onClick:n[19]||(n[19]=o=>ze())},{default:s(()=>[$(p(e.$t("activity.editConnJson")),1)]),_:1})])]),_:1})]),_:1})],64))]),l(d,{class:"flex justify-end !mt-5"},{default:s(()=>[i("div",Zt,[l(w,{type:t(C)?"ghost":"primary",size:"small",class:"nc-extdb-btn-test-connection !rounded-md",loading:t(q),onClick:Oe},{default:s(()=>[t(C)?(c(),b(Je,{key:0,icon:"circleCheck",class:"text-primary mr-2"})):x("",!0),$(" "+p(e.$t("activity.testDbConn")),1)]),_:1},8,["type","loading"]),l(w,{size:"small",type:"primary",disabled:!t(C),loading:t(U),class:"nc-extdb-btn-submit !rounded-md",onClick:Me},{default:s(()=>[$(p(e.$t("general.submit")),1)]),_:1},8,["disabled","loading"])])]),_:1})]),_:1},8,["model"]),l(be,{visible:t(I),"onUpdate:visible":n[21]||(n[21]=o=>R(I)?I.value=o:null),title:e.$t("activity.editConnJson"),width:"600px","wrap-class-name":"nc-modal-edit-connection-json",onOk:Be},{default:s(()=>[t(I)?(c(),b(Ye,{key:0,modelValue:t(E),"onUpdate:modelValue":n[20]||(n[20]=o=>R(E)?E.value=o:null),class:"h-[400px] w-full"},null,8,["modelValue"])):x("",!0)]),_:1},8,["visible","title"]),l(be,{visible:t(M),"onUpdate:visible":n[23]||(n[23]=o=>R(M)?M.value=o:null),title:e.$t("activity.useConnectionUrl"),width:"500px","ok-text":e.$t("general.ok"),"cancel-text":e.$t("general.cancel"),"wrap-class-name":"nc-modal-connection-url",onOk:Ve},{default:s(()=>[l(m,{value:t(P),"onUpdate:value":n[22]||(n[22]=o=>R(P)?P.value=o:null)},null,8,["value"])]),_:1},8,["visible","title","ok-text","cancel-text"])])])]),_:1},8,["visible","closable","keyboard"])}}});const on=ke(ea,[["__scopeId","data-v-4b2fbe9e"]]);export{on as default};
