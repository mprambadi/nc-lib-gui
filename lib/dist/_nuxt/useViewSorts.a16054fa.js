import{a as M,f as P}from"./bases.e6c8e3c4.js";import{aM as $,bF as C,bb as E,r as B,gB as F,X as h,Y as _,gp as j,C as N}from"./entry.5958c07b.js";import{R as X,b as Y}from"./index.9b87fcff.js";import{a as q}from"./useSmartsheetStore.f1a70558.js";function Q(i,m){const{sorts:e,eventBus:O}=q(),{$api:c,$e:f}=N(),{isUIAllowed:T}=$(),{isSharedBase:x}=C(M()),{addUndo:b,clone:o,defineViewScope:p}=P(),v=E(X),w=E(Y,B(!1)),S=B([]);F(e,t=>{S.value=o(t)});const U=async()=>{if(w.value){e.value=[];return}try{if(!T("sortSync")||!(i!=null&&i.value))return;e.value=(await c.dbTableSort.list(i.value.id)).list}catch(t){console.error(t),h.error(await _(t))}},L=(t,s)=>Object.entries(s).filter(([a,u])=>t[a]!==u&&a in t).reduce((a,[u,r])=>({...a,[u]:r}),{}),y=async(t,s,a=!1)=>{var u;if(!a){const r=S.value[s];if(r){const l=o(L(t,r));Object.keys(l).length>0&&b({undo:{fn:(g,d)=>{const n=e.value[s];n&&(n[g]=d,y(n,s,!0))},args:[Object.keys(l)[0],Object.values(l)[0]]},redo:{fn:(g,d)=>{const n=e.value[s];n&&(n[g]=d,y(n,s,!0))},args:[Object.keys(l)[0],t[Object.keys(l)[0]]]},scope:p({view:i.value})})}}if(w.value||x.value){e.value[s]=t,e.value=[...e.value],v==null||v.trigger();return}try{T("sortSync")&&(t.id?(await c.dbTableSort.update(t.id,t),f("sort-updated")):e.value[s]=await c.dbTableSort.create((u=i.value)==null?void 0:u.id,t)),m==null||m(),f("a:sort:dir",{direction:t.direction})}catch(r){console.error(r),h.error(await _(r))}S.value=o(e.value)},V=async({direction:t,column:s,reloadDataHook:a})=>{var u;try{f("a:sort:add",{from:"column-menu"});const r=e.value.findIndex(d=>d.fk_column_id===s.id),l=r>-1?e.value[r]:void 0;l&&(await c.dbTableSort.delete(l.id),f("a:sort:delete"));const g=await c.dbTableSort.create((u=i.value)==null?void 0:u.id,{fk_column_id:s.id,direction:t,push_to_top:!0});e.value=[...e.value.filter((d,n)=>n!==r),g],b({redo:{fn:async function(){var A;const n=await c.dbTableSort.create((A=i.value)==null?void 0:A.id,{fk_column_id:s.id,direction:t,push_to_top:!0});this.undo.args=[n.id],O.emit(j.SORT_RELOAD),a==null||a.trigger()},args:[]},undo:{fn:async function(n){await c.dbTableSort.delete(n),O.emit(j.SORT_RELOAD),a==null||a.trigger()},args:[g.id]},scope:p({view:i.value})}),O.emit(j.SORT_RELOAD),a==null||a.trigger()}catch(r){console.error(r),h.error(await _(r))}};async function R(t,s,a=!1){try{T("sortSync")&&t.id&&!w.value&&!x.value&&await c.dbTableSort.delete(t.id),e.value.splice(s,1),e.value=[...e.value],a||b({redo:{fn:async()=>{await R(t,s,!0)},args:[]},undo:{fn:()=>{e.value.splice(s,0,t),y(t,s,!0)},args:[o(t),s]},scope:p({view:i.value})}),S.value=o(e.value),v==null||v.trigger(),f("a:sort:delete")}catch(u){console.error(u),h.error(await _(u))}}const I=(t=!1,s)=>{var a;e.value=[...e.value,{fk_column_id:s==null?void 0:s.id,direction:"asc"}],f("a:sort:add",{length:(a=e==null?void 0:e.value)==null?void 0:a.length}),t||b({undo:{fn:async()=>{await R(e.value[e.value.length-1],e.value.length-1,!0)},args:[]},redo:{fn:()=>{I(!0)},args:[]},scope:p({view:i.value})}),S.value=o(e.value)};return{sorts:e,loadSorts:U,addSort:I,deleteSort:R,saveOrUpdate:y,insertSort:V}}export{Q as u};
