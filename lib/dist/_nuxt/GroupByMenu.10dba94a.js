import{f as pe,bu as Be,r as m,bb as z,g as G,cG as c,cZ as me,fU as xe,eZ as _e,eX as fe,H as le,i as ve,c9 as ye,o as s,c as b,a as f,au as P,ey as Ce,O as t,W as ae,t as S,T as j,U as W,V as ie,S as Y,b as M,w as p,d as Oe,bv as ne,cb as O,$ as $e,P as y,Q as se,R as re,a0 as Le,a1 as Ge,go as Me,X as de,a8 as Se,af as Te,C as Ve}from"./entry.96205fa0.js";import{_ as De}from"./Icon.vue.dcf4a73e.js";import{_ as Ie}from"./Tooltip.vue.00c0d0fb.js";import{A as be,M as ge,f as Ue}from"./index.9b87fcff.js";import{u as we}from"./useViewColumns.8927231f.js";import{u as Ae}from"./useViewGroupBy.56fce787.js";import{_ as Ne}from"./Select.vue.5a200a6a.js";import{_ as Re}from"./Button.vue.02ce6d5b.js";import{_ as Ee}from"./Icon.vue.6d0583a0.js";import{_ as Fe}from"./Dropdown.vue.93f98e1e.js";import{g as je}from"./sortUtils.a6fe70e8.js";import{u as ze}from"./index.e38f94a1.js";import{b as Pe}from"./bases.965a49bb.js";import{a as Ke}from"./useSmartsheetStore.7d51347e.js";import{S as Qe}from"./index.b5e393d6.js";import{_ as He}from"./_plugin-vue_export-helper.c27b6911.js";import"./VirtualCellIcon.79739fcf.js";import"./virtualCell.9142cfee.js";import"./CellIcon.0a028b40.js";import"./cell.810c4fd3.js";import"./index.e034edbd.js";import"./useSharedView.9e320acb.js";import"./index.9e8f59f4.js";import"./debounce.1d5af9bf.js";import"./toNumber.ed208f2f.js";import"./isSymbol.d46b4957.js";import"./index.6c1d17b6.js";import"./Dropdown.1dedd322.js";import"./RightOutlined.3ce786f5.js";import"./index.0c5b3837.js";import"./views.2c163cf7.js";import"./toArray.3561b70e.js";import"./antInputDirective.8ac36ea7.js";import"./isMobile.e2e89480.js";import"./useMemo.dbc63a5f.js";import"./useState.5a301439.js";import"./CheckOutlined.3b90c20d.js";import"./SearchOutlined.c9794270.js";import"./FormItemContext.b19eb48c.js";const Xe=["onKeydown"],Ze={class:"flex pb-3 px-4 border-b-1 border-gray-100"},We=["placeholder"],Ye={class:"flex-col w-full max-h-100 max-w-76 nc-scrollbar-md !overflow-y-auto"},qe={key:0,class:"flex text-gray-500 px-4 py-2.25"},Je=["onClick"],eo=pe({__name:"CreateGroupBy",props:{isParentOpen:{type:Boolean},columns:{}},emits:["created"],setup(A,{emit:q}){const T=A,J=q,{isParentOpen:K,columns:N}=Be(T),R=m(),g=m(""),w=m(-1),ee=z(be,m()),u=z(ge,m()),{showSystemFields:Q,metaColumnById:h}=we(),{groupBy:V}=Ae(ee),D=G(()=>{var a,v;return((v=N.value||((a=u.value)==null?void 0:a.columns))==null?void 0:v.filter(r=>{var d;return r.uidt===c.Links?!0:me((d=h==null?void 0:h.value)==null?void 0:d[r.id])?r!=null&&r.colOptions||xe(r)?!1:Q.value:r.uidt===c.QrCode||r.uidt===c.Barcode||r.uidt===c.ID?!1:!(_e(r)&&r.colOptions.type!==fe.BELONGS_TO)}).filter(r=>!V.value.find(d=>{var I;return((I=d.column)==null?void 0:I.id)===r.id})).filter(r=>{var d;return(d=r.title)==null?void 0:d.toLowerCase().includes(g.value.toLowerCase())}))??[]}),H=a=>{J("created",a)};le(K,()=>{K.value&&setTimeout(()=>{var a;(a=R.value)==null||a.focus()},100)},{immediate:!0}),ve(()=>{g.value="",w.value=-1});const X=()=>{w.value=Math.min(w.value+1,D.value.length-1)},k=()=>{w.value=Math.max(w.value-1,0)};return(a,v)=>{const r=De,d=Ie,I=ye("e");return s(),b("div",{class:"flex flex-col w-full pt-4 pb-2 min-w-64 nc-group-by-create-modal",onKeydown:[ne(O(X,["prevent"]),["arrow-down"]),ne(O(k,["prevent"]),["arrow-up"]),v[1]||(v[1]=ne(O(i=>H(t(D)[t(w)]),["prevent"]),["enter"]))]},[f("div",Ze,[P(f("input",{ref_key:"inputRef",ref:R,"onUpdate:modelValue":v[0]||(v[0]=i=>ae(g)?g.value=i:null),class:"w-full focus:outline-none",placeholder:a.$t("msg.selectFieldToGroup")},null,8,We),[[Ce,t(g)]])]),f("div",Ye,[t(D).length?j("",!0):(s(),b("div",qe,S(a.$t("general.empty")),1)),(s(!0),b(W,null,ie(t(D),(i,$)=>P((s(),b("div",{key:$,class:Y(["flex flex-row h-10 items-center gap-x-1.5 px-2.5 hover:bg-gray-100 cursor-pointer nc-group-by-column-search-item",{"bg-gray-100":t(w)===$}]),onClick:oe=>H(i)},[M(r,{column:i},null,8,["column"]),M(d,{class:"truncate"},{title:p(()=>[Oe(S(i.title),1)]),default:p(()=>[f("span",null,S(i.title),1)]),_:2},1024)],10,Je)),[[I,["c:group-by:add:column:select"]]])),128))])],40,Xe)}}}),oo=Le(()=>Ge(()=>import("./FieldListAutoCompleteDropdown.d3351596.js"),["./FieldListAutoCompleteDropdown.d3351596.js","./FieldListAutoCompleteDropdown.vue.f84f4d57.js","./VirtualCellIcon.79739fcf.js","./index.9b87fcff.js","./entry.96205fa0.js","./entry.d09b2482.css","./virtualCell.9142cfee.js","./CellIcon.0a028b40.js","./cell.810c4fd3.js","./bases.965a49bb.js","./index.0c5b3837.js","./Tooltip.vue.00c0d0fb.js","./Tooltip.b86f91a1.css","./Select.vue.5a200a6a.js","./Button.vue.02ce6d5b.js","./index.9e8f59f4.js","./debounce.1d5af9bf.js","./toNumber.ed208f2f.js","./isSymbol.d46b4957.js","./_plugin-vue_export-helper.c27b6911.js","./Button.ff10bcb0.css","./Icon.vue.6d0583a0.js","./index.b5e393d6.js","./toArray.3561b70e.js","./antInputDirective.8ac36ea7.js","./isMobile.e2e89480.js","./useMemo.dbc63a5f.js","./useState.5a301439.js","./CheckOutlined.3b90c20d.js","./SearchOutlined.c9794270.js","./FormItemContext.b19eb48c.js","./Select.aa34986b.css","./useViewColumns.8927231f.js","./index.e034edbd.js","./FieldListAutoCompleteDropdown.57f54ee1.css"],import.meta.url).then(A=>A.default||A)),to={class:"flex items-center gap-2"},no={key:0,class:"text-capitalize !text-sm font-medium"},so={key:1,class:"bg-brand-50 text-brand-500 py-1 px-2 text-md rounded-md"},ro={class:"flex items-center justify-between gap-2"},lo={class:"truncate flex-1"},ao={class:"flex gap-1 items-center"},io={class:"flex"},uo=pe({__name:"GroupByMenu",setup(A){const q=[c.Attachment],T=z(ge,m()),J=z(be,m()),K=z(Ue,m(!1)),{gridViewCols:N,updateGridViewColumn:R,metaColumnById:g,showSystemFields:w}=we(),{$e:ee}=Ve(),u=m([]),{getMeta:Q}=Pe(),h=G(()=>{const o=[];return Object.values(N.value).forEach(e=>{e.group_by&&o.push({fk_column_id:e.fk_column_id,sort:e.group_by_sort||"asc",order:e.group_by_order||1})}),o.sort((e,n)=>e.order-n.order),o}),V=G(()=>h.value.map(o=>o.fk_column_id).filter(o=>o)),{eventBus:D}=Ke(),{isMobileMode:H}=$e(),X=m([]),k=m(!1),a=G(()=>{var e;return(((e=T.value)==null?void 0:e.columns)||[]).filter(n=>q.includes(n.uidt)?!1:n.uidt===c.Lookup?n.id&&X.value.includes(n.id):!0)}),v=G(()=>{var o;return((o=T.value)==null?void 0:o.columns)||[]}),r=G(()=>v.value.reduce((o,e)=>(o[e.id]=e,o),{})),d=G(()=>{var o;return(o=v.value)==null?void 0:o.filter(e=>{var n;return e.uidt===c.Links?!0:me((n=g==null?void 0:g.value)==null?void 0:n[e.id])?w.value:e.uidt===c.QrCode||e.uidt===c.Barcode||e.uidt===c.ID?!1:!(_e(e)&&e.colOptions.type!==fe.BELONGS_TO)}).filter(e=>!h.value.find(n=>n.fk_column_id===e.id))}),I=o=>{var e;return o&&((e=r.value[o])==null?void 0:e.uidt)||""},i=m(!1);ze(i);const $=async()=>{var o;if((o=J.value)!=null&&o.id)try{for(const e of u.value){if(!e.fk_column_id)continue;const n=N.value[e.fk_column_id];n&&(!n.group_by||n.group_by_order!==e.order||n.group_by_sort!==e.sort)&&await R(e.fk_column_id,{group_by:!0,group_by_order:e.order,group_by_sort:e.sort})}for(const e of h.value){if(!e.fk_column_id||u.value.find(L=>L.fk_column_id===e.fk_column_id))continue;const n=N.value[e.fk_column_id];n&&n.group_by&&await R(e.fk_column_id,{group_by:!1,group_by_order:void 0,group_by_sort:void 0})}ee("a:group-by:update",{groupBy:h.value}),D.emit(Me.GROUP_BY_RELOAD)}catch{de.error("There was an error while updating view!")}else de.error("View not found!!!")},oe=o=>{u.value.push({fk_column_id:o.id,sort:"asc",order:u.value.length+1}),$(),k.value=!1},he=async o=>{if(V.value.length===0){i.value=!1;return}u.value.splice(+o,1),await $()};le(i,()=>{i.value?u.value=[...h.value]:k.value=!1});const ue=async()=>{var e,n,L,Z;const o=[];try{for(const B of((e=T.value)==null?void 0:e.columns)||[]){if(B.uidt!==c.Lookup)continue;let l=B;for(;l&&l.uidt===c.Lookup;){const U=(L=(n=await Q(l.fk_model_id))==null?void 0:n.columns)==null?void 0:L.find(F=>F.id===(l==null?void 0:l.colOptions).fk_relation_column_id),E=await Q((U==null?void 0:U.colOptions).fk_related_model_id);if(l=(Z=E==null?void 0:E.columns)==null?void 0:Z.find(F=>F.id===(l==null?void 0:l.colOptions).fk_lookup_column_id),(l==null?void 0:l.id)===B.id)break}(l==null?void 0:l.uidt)!==c.Attachment&&B.id&&o.push(B.id)}X.value=o}catch(B){console.error(B)}};return ve(async()=>{await ue()}),le(T,async()=>{await ue()}),(o,e)=>{const n=Se,L=eo,Z=oo,B=Qe,l=Ne,U=Re,E=Te,F=Ee,ce=Fe,te=ye("e");return s(),y(ce,{visible:t(i),"onUpdate:visible":e[5]||(e[5]=x=>ae(i)?i.value=x:null),"offset-y":"",trigger:["click"],class:"!xs:hidden","overlay-class-name":"nc-dropdown-group-by-menu nc-toolbar-dropdown overflow-hidden"},{overlay:p(()=>[t(u).length?(s(),b("div",{key:1,class:Y([{" min-w-[400px]":t(u).length},"flex flex-col bg-white overflow-auto nc-group-by-list menu-filter-dropdown max-h-[max(80vh,500px)] py-6 pl-6"]),"data-testid":"nc-group-by-menu"},[f("div",{class:Y(["group-by-grid pb-1 max-h-100 nc-scrollbar-md pr-5",{"mb-2":t(d).length&&t(a).length>t(u).length&&t(u).length<3}]),onClick:e[2]||(e[2]=O(()=>{},["stop"]))},[(s(!0),b(W,null,ie(Object.entries(t(u)),([x,_])=>(s(),b(W,{key:`grouped-by-${_.fk_column_id}`},[M(Z,{modelValue:_.fk_column_id,"onUpdate:modelValue":C=>_.fk_column_id=C,class:"caption nc-sort-field-select",columns:t(a),"allow-empty":!0,onChange:$,onClick:e[0]||(e[0]=O(()=>{},["stop"]))},null,8,["modelValue","onUpdate:modelValue","columns"]),M(l,{ref_for:!0,ref:"",value:_.sort,"onUpdate:value":C=>_.sort=C,class:"shrink grow-0 nc-sort-dir-select",label:o.$t("labels.operation"),"dropdown-class-name":"sort-dir-dropdown nc-dropdown-sort-dir",disabled:!_.fk_column_id,onChange:$,onClick:e[1]||(e[1]=O(()=>{},["stop"]))},{default:p(()=>[(s(!0),b(W,null,ie(t(je)(I(_.fk_column_id)),(C,ke)=>(s(),y(B,{key:ke,value:C.value},{default:p(()=>[f("div",ro,[f("div",lo,S(C.text),1),_.sort===C.value?(s(),y(se(("iconMap"in o?o.iconMap:t(re)).check),{key:0,id:"nc-selected-item-icon",class:"text-primary w-4 h-4"})):j("",!0)])]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value","label","disabled"]),M(E,{placement:"right",title:"Remove"},{default:p(()=>[P((s(),y(U,{class:"nc-group-by-item-remove-btn",size:"small",type:"text",onClick:O(C=>he(x),["stop"])},{default:p(()=>[(s(),y(se(("iconMap"in o?o.iconMap:t(re)).deleteListItem)))]),_:2},1032,["onClick"])),[[te,["c:group-by:remove"]]])]),_:2},1024)],64))),128))],2),t(d).length&&t(a).length>t(u).length&&t(u).length<3?(s(),y(ce,{key:0,visible:t(k),"onUpdate:visible":e[4]||(e[4]=x=>ae(k)?k.value=x:null),trigger:["click"],"overlay-class-name":"nc-toolbar-dropdown"},{overlay:p(()=>[M(L,{"is-parent-open":t(k),columns:t(a),onCreated:oe},null,8,["is-parent-open","columns"])]),default:p(()=>[P((s(),y(U,{class:"nc-add-group-by-btn !text-brand-500",style:{width:"fit-content"},size:"small",type:"text",onClick:e[3]||(e[3]=O(x=>k.value=!0,["stop"]))},{default:p(()=>[f("div",ao,[f("div",io,S(o.$t("activity.addSubGroup")),1),M(F,{icon:"plus"})])]),_:1})),[[te,["c:group-by:add"]]])]),_:1},8,["visible"])):j("",!0)],2)):(s(),y(L,{key:0,"is-parent-open":t(i),columns:t(a),onCreated:oe},null,8,["is-parent-open","columns"]))]),default:p(()=>{var x;return[f("div",{class:Y({"nc-active-btn":(x=t(V))==null?void 0:x.length})},[P((s(),y(n,{class:"nc-group-by-menu-btn nc-toolbar-btn",disabled:t(K)},{default:p(()=>{var _;return[f("div",to,[(s(),y(se(("iconMap"in o?o.iconMap:t(re)).group),{class:"h-4 w-4"})),t(H)?j("",!0):(s(),b("span",no,S(o.$t("activity.groupBy")),1)),(_=t(V))!=null&&_.length?(s(),b("span",so,S(t(V).length),1)):j("",!0)])]}),_:1},8,["disabled"])),[[te,["c:group-by"]]])],2)]}),_:1},8,["visible"])}}});const Wo=He(uo,[["__scopeId","data-v-a366fb43"]]);export{Wo as default};
