import{by as pe,u as Z,g as w,r as j,a6 as ge,bz as we,X as J,bA as fe,aL as ae,bB as me,$ as se,bC as re,H as z,Y as X,D as V,C as K,L as oe,aM as he,bD as ye,bE as te,bF as le,bG as de,bH as ve,i as ke}from"./entry.5958c07b.js";import{r as Pe}from"./index.0feaca99.js";function Ee(y){if(!y)return{};try{return typeof y=="string"?JSON.parse(y):y}catch{return{}}}function _e(y){if(y)try{return typeof y=="string"?y:JSON.stringify(y)}catch{return"{}"}}const Te=pe(()=>{const y=Pe(),B=Z().currentRoute,d=w(()=>{const e=[{key:"root",param:"root"}];for(const[c,n]of Object.entries(B.value.params))Array.isArray(n)?e.push({key:c,param:n.join(",")}):e.push({key:c,param:n});return e}),h=e=>{const c=d.value.find(n=>n.key==="slugs");return c&&(Array.isArray(c.param)?c.param:c.param.split(",")).some(v=>["webhook","field","api","relation"].includes(v))?!1:e.every(n=>d.value.some(v=>Array.isArray(n.param)?n.key==="viewTitle"&&v.key==="viewTitle"&&v.param===""||n.key===v.key&&n.param.includes(v.param):n.key==="viewTitle"&&v.key==="viewTitle"&&v.param===""||n.key===v.key&&n.param===v.param))},b=j([]),_=j([]),E=(e,c=!1)=>{c||(_.value=_.value.filter(n=>!h(n.scope||[]))),b.value.push(e)},N=e=>{_.value.push(e)},I=async()=>{let e=-1;for(let n=b.value.length-1;n>=0;n--){const v=b.value[n].scope||[{key:"root",param:"root"}];if(h(v)){e=n;break}}if(e===-1)return;const c=b.value.splice(e,1)[0];if(c)try{await c.undo.fn.apply(c,c.undo.args),N(c)}catch{J.warn("Error while undoing action, it is skipped.")}},s=async()=>{let e=-1;for(let n=_.value.length-1;n>=0;n--){const v=_.value[n].scope||[{key:"root",param:"root"}];if(h(v)){e=n;break}}if(e===-1)return;const c=_.value.splice(e,1)[0];if(c)try{await c.redo.fn.apply(c,c.redo.args),E(c,!0)}catch{J.warn("Error while redoing action, it is skipped.")}},l=()=>[{key:"root",param:"root"}],S=e=>e.base?[{key:"baseId",param:e.base.id}]:e.model?[{key:"baseId",param:e.model.base_id}]:e.view?[{key:"baseId",param:e.view.base_id}]:[{key:"baseId",param:e.base_id}],U=e=>e.model?[{key:"baseId",param:e.model.base_id},{key:"viewId",param:e.model.id}]:e.view?[{key:"baseId",param:e.view.base_id},{key:"viewId",param:e.view.fk_model_id}]:[{key:"baseId",param:e.base_id},{key:"viewId",param:e.model_id}],L=e=>e.view?[{key:"baseId",param:e.view.base_id},{key:"viewId",param:e.view.fk_model_id},{key:"viewTitle",param:[e.view.title,e.view.id]}]:[{key:"baseId",param:e.base_id},{key:"viewId",param:e.model_id},{key:"viewTitle",param:[e.title,e.id]}];return ge(document,"keydown",async e=>{const c=we()?e.metaKey:e.ctrlKey;if(!(e&&(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement))&&c&&!e.altKey)switch(e.keyCode){case 90:{e.preventDefault(),e.shiftKey?_.value.length&&s():b.value.length&&I();break}}}),{addUndo:E,undo:I,clone:y,defineRootScope:l,defineProjectScope:S,defineModelScope:U,defineViewScope:L}}),ne=pe(()=>{const y=j(),u=fe(),B=j("Quick actions"),d=w(()=>{}),h=w(()=>({})),b=(..._)=>{};return{commandPalette:y,cmdData:d,activeScope:h,cmdPlaceholder:B,refreshCommandPalette:u.trigger,loadTemporaryScope:b}}),be=ae("workspaceStore",()=>{const y=ce(),u=j(),d=Z().currentRoute,{$api:h}=K(),{refreshCommandPalette:b}=ne(),_=j(null),{setTheme:E,theme:N}=me(),{$e:I}=K(),{appInfo:s,ncNavigateTo:l}=se(),S=j(new Map),U=w(()=>Array.from(S.value.values()).sort((o,P)=>o.updated_at-P.updated_at)),L=w(()=>d.value.name==="index-typeOrId-settings"),e=j(!0),c=j(!0),n=j(!1),v=j(void 0),$=w(()=>d.value.query.page??"recent"),q=w(()=>"default"),T=w(()=>({id:"default",title:"default",meta:{},roles:""})),t=w(()=>{const o={};if(!T.value)return o;try{return(re(T.value.meta)?JSON.parse(T.value.meta):T.value.meta)??o}catch{return o}}),k=async(o=!1)=>{},m=async(...o)=>{},p=async(...o)=>{},M=async(o,{skipStateUpdate:P}={})=>{},W=async(...o)=>{},O=async(...o)=>{},G=async(...o)=>{},Q=async(...o)=>{},D=async(...o)=>{};async function ee(...o){e.value=!0;try{await y.loadProjects()}catch(P){console.error(P)}finally{e.value=!1}}z($,async o=>{o!=="workspace"&&await y.loadProjects(o)});const Y=async o=>{var P;try{const ue=y.bases.get(o);if(!ue)return;ue.starred=!0,await h.base.userMetaUpdate(o,{starred:!0},{baseURL:s.value.baseHostName?`https://${(P=T.value)==null?void 0:P.id}.${s.value.baseHostName}`:void 0})}catch(F){J.error(await X(F))}},a=async o=>{var P;try{const F=y.bases.get(o);if(!F)return;F.starred=!1,await h.base.userMetaUpdate(o,{starred:!1},{baseURL:s.value.baseHostName?`https://${(P=T.value)==null?void 0:P.id}.${s.value.baseHostName}`:void 0})}catch(F){J.error(await X(F))}},i=async o=>{try{await h.base.update(o.id,{title:o.temp_title},{baseURL:s.value.baseHostName?`https://${T.value.id}.${s.value.baseHostName}`:void 0}),o.title=o.temp_title,o.edit=!1,b()}catch(P){J.error(await X(P))}},f=async(...o)=>{};async function C(o){const P={primaryColor:N.value.primaryColor,accentColor:N.value.accentColor,...o};await p(T.value.id,{meta:{...T.value,theme:P}}),E(P),I("c:themes:change")}async function R(){await y.clearBases(),S.value.clear()}const A=async()=>{},H=async o=>{if(o=o||q.value,!o)throw new Error("Workspace not selected");await l({workspaceId:o})},x=async()=>{V("/account/users")};function r(o=!1){e.value=o}return{loadWorkspaces:k,workspaces:S,workspacesList:U,createWorkspace:m,deleteWorkspace:M,updateWorkspace:p,activeWorkspace:T,loadCollaborators:W,inviteCollaborator:O,removeCollaborator:G,updateCollaborator:Q,collaborators:u,isInvitingCollaborators:n,isCollaboratorsLoading:c,addToFavourite:Y,removeFromFavourite:a,activeWorkspaceId:q,activePage:$,updateProjectTitle:i,moveWorkspace:f,loadWorkspace:D,saveTheme:C,activeWorkspaceMeta:t,isWorkspaceLoading:e,populateWorkspace:ee,clearWorkspaces:R,upgradeActiveWorkspace:A,navigateToWorkspace:H,setLoadingState:r,navigateToWorkspaceSettings:x,lastPopulatedWorkspaceId:_,isWorkspaceSettingsPageOpened:L,workspaceUserCount:v,getPlanLimit:o=>9999}}),Ie=ae("baseStore",()=>{const{$e:y}=K(),{api:u,isLoading:B}=oe(),d=Z(),h=d.currentRoute,{setTheme:b,theme:_}=me(),{loadRoles:E}=he(),{refreshCommandPalette:N}=ne(),I=j(),s=w(()=>I.value||h.value.params.baseId),l=ce(),S=ie(),U=j(),L=w(()=>l.bases.get(s.value)),e=w(()=>l.bases.get(s.value)||U.value||{}),c=w(()=>S.baseTables.get(s.value)||[]),n=fe(),v=w(()=>{var r;return((r=e.value)==null?void 0:r.sources)||[]}),$=j(),q=j({}),T=w(()=>h.value.params.typeOrId),t=w(()=>{const r={showNullAndEmptyInFilter:!1};try{return(re(e.value.meta)?JSON.parse(e.value.meta):e.value.meta)??r}catch{return r}}),k=w(()=>{const r={};for(const g of v.value)g.id&&(r[g.id]=ye.create({client:g.type}));return r});function m(r){var g;return((g=v.value.find(o=>o.id===r))==null?void 0:g.type)||te.MYSQL}function p(r){return["mysql",te.MYSQL].includes(m(r))}function M(r){return m(r)===te.SQLITE}function W(r){return m(r)==="mssql"}function O(r){return m(r)==="pg"}function G(r){const g=v.value.find(o=>o.id===r);return(g==null?void 0:g.is_meta)||(g==null?void 0:g.is_local)||!1}const Q=w(()=>T.value==="base"),D=w(()=>T.value==="ERD");async function ee(r){(!$.value||r)&&($.value=await u.base.metaGet(e.value.id,{}))}async function Y(){e.value.id&&await S.loadProjectTables(e.value.id,!0)}async function a(r=!0,g){var o;if(g&&(I.value=g),T.value==="base")try{const P=await u.public.sharedBaseGet(h.value.params.baseId);I.value=P.base_id,U.value=await u.base.read(P.base_id)}catch(P){if(((o=P==null?void 0:P.response)==null?void 0:o.status)===404)return d.push("/error/404");throw P}else if(s.value)await l.loadProject(s.value);else{console.warn("Base id not found");return}return Q.value?await E(e.value.id||s.value,{isSharedBase:Q.value,sharedBaseId:h.value.params.baseId}):D.value?await E(e.value.id||s.value,{isSharedErd:D.value,sharedErdId:h.value.params.erdUuid}):await E(e.value.id||s.value),await Y(),await l.getBaseUsers({baseId:e.value.id||s.value}),n.trigger(e.value)}async function i(r){T.value!=="base"&&(r.meta&&typeof r.meta=="string"?await u.base.update(s.value,r):await u.base.update(s.value,{...r,meta:_e(r.meta)}),N())}async function f(r){const g={primaryColor:_.value.primaryColor,accentColor:_.value.accentColor,...r};await i({color:g.primaryColor,meta:{...t.value,theme:g}}),y("c:themes:change")}async function C(){return await u.base.hasEmptyOrNullFilters(s.value)}const R=()=>{$.value=void 0,b()},A=r=>{U.value=r},H=({id:r,type:g,isSharedBase:o})=>{if(o){const P=h.value.params.typeOrId,F=h.value.params.baseId;return`/${P}/${F}`}return`/nc/${r}`};z(()=>h.value.params.baseType,r=>{r||R()},{immediate:!0}),z(()=>{var r;return(r=L.value)==null?void 0:r.id},()=>{L.value&&(L.value.isExpanded||(L.value.isExpanded=!0))});const x=async({page:r})=>{await d.push({name:"index-typeOrId-baseId-index-index",params:{typeOrId:h.value.params.typeOrId,baseId:h.value.params.baseId},query:{page:r}})};return{base:e,sources:v,tables:c,loadRoles:E,loadProject:a,updateProject:i,loadTables:Y,isMysql:p,isMssql:W,isPg:O,isSqlite:M,sqlUis:k,isSharedBase:Q,isSharedErd:D,loadProjectMetaInfo:ee,baseMetaInfo:$,baseMeta:t,saveTheme:f,baseLoadedHook:n.on,reset:R,isLoading:B,lastOpenedViewMap:q,isXcdbBase:G,hasEmptyOrNullFilters:C,setProject:A,baseUrl:H,getBaseType:m,navigateToProjectPage:x}});function Se(){const{$api:y}=K(),{tables:u}=le(Ie()),{baseTables:B}=le(ie()),d=de("metas",()=>({})),h=w(()=>{const s=Object.entries(d.value).filter(([l,S])=>l===S.id);return Object.fromEntries(s)}),b=de("metas-loading-state",()=>({}));return{getMeta:async(s,l=!1,S=!1,U)=>{var e;if(!s)return null;const L=(U?B.value.get(U):u.value)??[];for(;!l&&b.value[s];)if(await new Promise(c=>{let n;const v=setTimeout(()=>{n==null||n(),clearTimeout(v),c(null)},1e4);n=z(()=>!!b.value[s],$=>{$||(clearTimeout(v),n==null||n(),c(null))},{immediate:!0})}),d.value[s])return d.value[s];if(S)return null;b.value[s]=!0;try{if(!l&&d.value[s])return d.value[s];const c=(e=L.find(v=>v.id===s)||L.find(v=>v.title===s))==null?void 0:e.id;if(!c)return console.warn(`Table '${s}' is not found in the table list`),null;const n=await y.dbTable.read(c);return d.value={...d.value,[n.id]:n,[n.title]:n},n}catch(c){J.error(await X(c))}finally{delete b.value[s]}return null},clearAllMeta:()=>{d.value={}},metas:d,metasWithIdAsKey:h,removeMeta:s=>{const l=d.value[s];l&&(delete d.value[l.id],delete d.value[l.title])},setMeta:async s=>{d.value={...d.value,[s.id]:s,[s.title]:s}}}}const ie=ae("tablesStore",()=>{const{includeM2M:y,ncNavigateTo:u}=se(),{api:B}=oe(),{$e:d,$api:h}=K(),{addUndo:b,defineProjectScope:_}=Te(),{refreshCommandPalette:E}=ne(),N=Z(),I=N.currentRoute,s=j(new Map),l=ce(),S=be(),U=w(()=>I.value.params.viewId),L=w(()=>{if(!l)return[];const t=l.activeProjectId;if(!t)return[];const k=s.value.get(t);if(!k)return[];const m=l.openedProjectBasesMap;return k.filter(p=>{var M;return!p.source_id||((M=m.get(p.source_id))==null?void 0:M.enabled)})}),e=w(()=>{if(!l)return;const t=l.activeProjectId;if(!(!t||!s.value.get(t)))return L.value.find(m=>m.id===U.value)});z(()=>{var t;return(t=e.value)==null?void 0:t.title},t=>{var k,m,p;if(((k=l.openedProject)==null?void 0:k.type)==="database"){if(!t){ve((m=l.openedProject)==null?void 0:m.title);return}ve(`${(p=l.openedProject)==null?void 0:p.title}: ${t}`)}});const c=async(t,k=!1)=>{var M;if(!k&&s.value.get(t)||s.value.get(t)&&!k)return;const p=await B.dbTable.list(t,{includeM2M:y.value});(M=p.list)==null||M.forEach(W=>{let O=W.meta;if(typeof O=="string")try{O=JSON.parse(O)}catch(G){console.error(G)}O||(O={}),W.meta=O}),s.value.set(t,p.list||[])},n=(t,k)=>{const m=s.value.get(t);m&&m.push(k)},v=async({baseId:t,tableId:k,viewTitle:m,workspaceId:p})=>{const M=p??S.activeWorkspaceId,W=t??l.activeProjectId;await u({workspaceId:M,baseId:W,tableId:k,viewId:m,query:I.value.query})},$=async t=>{if(!t.base_id)return;const k=l.bases,m=S.activeWorkspaceId;let p=k.get(t.base_id);if(!p&&(await l.loadProject(t.base_id),await c(t.base_id),p=k.get(t.base_id),!p))throw new Error("Base not found");const{getMeta:M}=Se();await M(t.id);let W=m;["nc","base"].includes(I.value.params.typeOrId)&&(W=I.value.params.typeOrId);let O=p.id;["base"].includes(I.value.params.typeOrId)&&(O=I.value.params.baseId),u({workspaceId:W,baseId:O,tableId:t==null?void 0:t.id})},q=async(t,k)=>{if(t)try{await h.dbTable.update(t.id,{base_id:t.base_id,table_name:t.table_name,title:t.title}),await c(t.base_id,!0),k||b({redo:{fn:p=>{t.title=p,q(t,!0)},args:[t.title]},undo:{fn:p=>{t.title=p,q(t,!0)},args:[t.title]},scope:_({model:t})});const m=await h.dbTable.read(t.id);s.value.set(t.base_id,s.value.get(t.base_id).map(p=>p.id===t.id?{...p,...m}:p)),E(),d("a:table:rename")}catch(m){J.error(await X(m))}};return{baseTables:s,loadProjectTables:c,addTable:n,activeTable:e,activeTables:L,openTable:$,updateTable:q,activeTableId:U,navigateToTable:v,tableUrl:({table:t,completeUrl:k})=>{const m=l.bases.get(t.base_id);if(!m)return;const p="index-typeOrId-baseId-index-index-viewId-viewTitle",M=N.resolve({name:p,params:{typeOrId:S.activeWorkspaceId,baseId:m.id,viewId:t.id}});return k?`${window.location.origin}/${M.href}`:M.href}}}),ce=ae("basesStore",()=>{const{$api:y}=K(),u=j(new Map),B=w(()=>Array.from(u.value.values()).sort((a,i)=>a.updated_at-i.updated_at)),d=j(new Map),b=Z().currentRoute,_=w(()=>{var a,i;return b.value.params.typeOrId==="base"?(i=(a=B.value)==null?void 0:a[0])==null?void 0:i.id:b.value.params.baseId}),E=w(()=>_.value?u.value.get(_.value):void 0),N=w(()=>{const a=new Map;if(!E.value||!E.value.sources)return a;for(const i of E.value.sources)a.set(i.id,i);return a}),I=be(),s=ie(),{api:l}=oe(),{getBaseUrl:S}=se(),U=j(!1);async function L({baseId:a,searchText:i,force:f=!1}){if(!f&&d.value.has(a)){const A=d.value.get(a);return{users:A,totalRows:(A==null?void 0:A.length)??0}}const C=await l.auth.baseUserList(a,{query:{query:i}}),R=C.users.pageInfo.totalRows??0;return d.value.set(a,C.users.list),{users:C.users.list,totalRows:R}}const e=()=>{d.value.clear()},c=async(a,i)=>{await l.auth.baseUserAdd(a,i)},n=async(a,i)=>{await l.auth.baseUserUpdate(a,i.id,i)},v=async(a,i)=>{await l.auth.baseUserRemove(a,i.id)},$=async(a="recent")=>{var R,A;if(b.value.params.typeOrId==="base"&&b.value.params.baseId){const{base_id:H}=await y.public.sharedBaseGet(b.value.params.baseId),x=await y.base.read(H);if(!x)return;u.value=[x].reduce((r,g)=>(r.set(g.id,g),r),new Map),u.value.set(x.id,{...u.value.get(x.id)||{},...x,sources:[...x.sources??((R=u.value.get(x.id))==null?void 0:R.sources)??[]],isExpanded:b.value.params.baseId===x.id||((A=u.value.get(x.id))==null?void 0:A.isExpanded),isLoading:!1});return}const i=I.activeWorkspace,f=I.workspace;if((!a||a==="workspace")&&!(f!=null&&f.id)&&!(i!=null&&i.id))throw new Error("Workspace not selected");let C=[];U.value=!0;try{const{list:H}=await y.base.list({baseURL:S((i==null?void 0:i.id)??(f==null?void 0:f.id))});C=H,u.value=C.reduce((x,r)=>{var o;const g=u.value.get(r.id)||{};return x.set(r.id,{...g,...r,isExpanded:b.value.params.baseId===r.id||((o=u.value.get(r.id))==null?void 0:o.isExpanded),isLoading:!1}),x},new Map)}catch(H){console.error(H),J.error(H.message)}finally{U.value=!1}};function q(a){return T(a)?u.value.get(a)?s.baseTables.get(a).length===0:!1:!0}function T(a){var f;const i=u.value.get(a);return i?!!((f=i.sources)!=null&&f.length&&s.baseTables.get(a)):!1}const t=async(a,i=!1)=>{if(!i&&T(a))return u.value.get(a);const f=await l.base.read(a);if(!f){await V("/");return}f.meta=f!=null&&f.meta&&typeof f.meta=="string"?JSON.parse(f.meta):{};const C=u.value.get(a)??{},R={...C,...f,isExpanded:b.value.params.baseId===a||C.isExpanded,isLoading:C.isLoading};u.value.set(a,R)},k=async(a,i)=>{u.value.get(a)||await t(a);let f=null;const C=u.value.get(a);for(const R of C.sources??[])if(R.id===i){f=ye.create({client:R.type});break}return f},m=async(a,i)=>{await l.base.update(a,i),await t(a,!0)},p=async a=>{const i=await l.base.create({title:a.title,linked_db_project_ids:a.linkedDbProjectIds},{baseURL:S("nc")});return await $(),i},M=async a=>{await l.base.delete(a),u.value.delete(a),s.baseTables.delete(a),await $()},W=a=>{const i=u.value.get(a);if(!i)throw new Error("Base not found");let f={showNullAndEmptyInFilter:!1};try{f=(re(i.meta)?JSON.parse(i.meta):i.meta)??f}catch{}return f};async function O(a){return await l.base.metaGet(a,{})}async function G(a,i){u.value.set(a,i)}async function Q(){u.value.clear()}const D=async({baseId:a,page:i})=>{if(!(!a||!u.value.get(a))){if(i)return await V(`/nc/${a}?page=${i}`);await V(`/nc/${a}`)}};return ke(()=>{_.value&&(T(_.value)||t(_.value))}),{bases:u,basesList:B,loadProjects:$,loadProject:t,getSqlUi:k,updateProject:m,createProject:p,deleteProject:M,getProjectMetaInfo:O,getProjectMeta:W,setProject:G,clearBases:Q,isProjectEmpty:q,isProjectPopulated:T,isProjectsLoading:U,activeProjectId:_,openedProject:E,openedProjectBasesMap:N,getBaseUsers:L,createProjectUser:c,updateProjectUser:n,navigateToProject:D,removeProjectUser:v,navigateToFirstProjectOrHome:async()=>{var a;(a=B.value)!=null&&a.length?await D({baseId:B.value[0].id}):V("/")},toggleStarred:async(...a)=>{},basesUser:d,clearBasesUser:e}});export{Ie as a,Se as b,ie as c,ne as d,be as e,Te as f,Ee as p,ce as u};
