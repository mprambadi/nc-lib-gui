import{u as W}from"./index.e61e381a.js";import{r as V,aM as Z,bF as q,g as k,cZ as U,H as J,C as K,fU as X,eN as Y}from"./entry.5958c07b.js";import{a as I,f as B}from"./bases.e6c8e3c4.js";const[le,D]=W((u,_,a,F=!1)=>{const t=V(),A=V(""),{$api:m,$e:E}=K(),{isUIAllowed:g}=Z(),{isSharedBase:$}=q(I()),x=V(!1),{addUndo:S,defineViewScope:M}=B(),C=k(()=>F||!g("viewFieldEdit")||!g("viewFieldEdit")||$.value),T=V([]),j=e=>{var s,i,l;return((s=u.value)==null?void 0:s.type)===Y.MAP&&((l=(i=u.value)==null?void 0:i.view)==null?void 0:l.fk_geo_data_col_id)===e.id},o=k(()=>{var e;return(e=_.value)!=null&&e.columns?_.value.columns.reduce((s,i)=>({...s,[i.id]:i}),{}):{}}),h=V({}),p=async()=>{var s,i,l,n,c;if(!_||!u)return;let e=1;if((s=u.value)!=null&&s.id){const v=(F?(i=_.value)==null?void 0:i.columns:(await m.dbViewColumn.list(u.value.id)).list).reduce((f,r)=>(r.show=!!r.show,{...f,[r.fk_column_id]:r}),{});if(t.value=(n=(l=_.value)==null?void 0:l.columns)==null?void 0:n.filter(f=>!(X(f)&&f.system)).map(f=>{var w;const r=v[f.id]||{};return{title:f.title,fk_column_id:f.id,...r,show:r.show||j(r),order:r.order||e++,system:U((w=o==null?void 0:o.value)==null?void 0:w[r.fk_column_id]),isViewEssentialField:j(f)}}).sort((f,r)=>f.order-r.order),C.value&&t.value)for(const f of T.value){const r=t.value.findIndex(w=>w.fk_column_id===f.fk_column_id);r!==void 0&&r>-1&&(t.value[r]=f,t.value=t.value.sort((w,Q)=>w.order-Q.order))}const b=(F.value?(c=u.value)==null?void 0:c.columns:t.value)??[];h.value=b.reduce((f,r)=>({...f,[r.fk_column_id]:r}),{})}},N=async e=>{var s,i;if(C.value){t.value=(s=t.value)==null?void 0:s.map(l=>({...l,show:!0})),a==null||a();return}(i=u==null?void 0:u.value)!=null&&i.id&&(e?await m.dbView.showAllColumn(u.value.id,{ignoreIds:e}):await m.dbView.showAllColumn(u.value.id)),await p(),a==null||a(),E("a:fields:show-all")},P=async e=>{var s,i;if(C.value){t.value=(s=t.value)==null?void 0:s.map(l=>({...l,show:!!l.isViewEssentialField})),a==null||a();return}(i=u==null?void 0:u.value)!=null&&i.id&&(e?await m.dbView.hideAllColumn(u.value.id,{ignoreIds:e}):await m.dbView.hideAllColumn(u.value.id)),await p(),a==null||a(),E("a:fields:show-all")},y=async(e,s,i=!1)=>{var l,n,c;if(C.value&&t.value&&(t.value[s]=e,_.value.columns=(l=_.value.columns)==null?void 0:l.map(d=>d.id===e.fk_column_id?{...d,...e,id:e.fk_column_id}:d),T.value.push(e)),g("viewFieldEdit")){if(e.id&&((n=u==null?void 0:u.value)!=null&&n.id))await m.dbViewColumn.update(u.value.id,e.id,e);else if((c=u.value)!=null&&c.id){const d=await m.dbViewColumn.create(u.value.id,e);return t.value&&(t.value[s]=d),d}}i||(await p(),a==null||a())},O=k({get(){var e;return((e=u.value)==null?void 0:e.show_system_fields)||!1},set(e){var s;(s=u==null?void 0:u.value)!=null&&s.id&&(C.value||m.dbView.update(u.value.id,{show_system_fields:e}).finally(()=>{p(),a==null||a()}),u.value.show_system_fields=e),E("a:fields:system-fields")}}),z=k(()=>{var e;return((e=t.value)==null?void 0:e.filter(s=>{var i,l,n;return(l=(i=o==null?void 0:o.value)==null?void 0:i[s.fk_column_id])!=null&&l.pv?!0:!O.value&&U((n=o==null?void 0:o.value)==null?void 0:n[s.fk_column_id])?!1:A.value===""?!0:s.title.toLowerCase().includes(A.value.toLowerCase())}))||[]}),G=k(()=>{var e,s,i;return((i=(s=(e=t==null?void 0:t.value)==null?void 0:e.filter(l=>{var n,c,d,v,b;return!O.value&&o.value&&((n=o==null?void 0:o.value)!=null&&n[l.fk_column_id])&&U((c=o.value)==null?void 0:c[l.fk_column_id])&&!((v=(d=o.value)==null?void 0:d[l.fk_column_id])!=null&&v.pv)?!1:l.show&&((b=o==null?void 0:o.value)==null?void 0:b[l.fk_column_id])}))==null?void 0:s.sort((l,n)=>l.order-n.order))==null?void 0:i.map(l=>{var n;return(n=o==null?void 0:o.value)==null?void 0:n[l.fk_column_id]}))||[]}),H=(e,s)=>{var l;const i=(l=t.value)==null?void 0:l.findIndex(n=>n.fk_column_id===s.fk_column_id);!i&&i!==0||(S({undo:{fn:n=>{s.show=!n,y(s,i)},args:[e]},redo:{fn:n=>{s.show=n,y(s,i)},args:[e]},scope:M({view:u.value})}),y(s,i))};J([()=>{var e;return(e=u==null?void 0:u.value)==null?void 0:e.id},()=>{var e;return(e=_.value)==null?void 0:e.columns}],async([e])=>{var s,i;if(e&&((s=u.value)==null?void 0:s.fk_model_id)===((i=_.value)==null?void 0:i.id)){x.value=!0;try{await p()}catch(l){console.error(l)}x.value=!1}},{immediate:!0});const R=V("200px"),L=async(e,s,i=!1)=>{var l,n;if(!i){const c=Object.keys(s).reduce((d,v)=>(h.value[e][v]&&(v==="width"?d[v]=`${R.value}px`:d[v]=h.value[e][v]),d),{});S({redo:{fn:d=>L(e,d,!0),args:[s]},undo:{fn:d=>L(e,d,!0),args:[c]},scope:M({view:u.value})})}!F.value&&g("viewFieldEdit")&&((l=h.value[e])!=null&&l.id)&&await m.dbView.gridColumnUpdate(h.value[e].id,{...s}),(n=h.value)!=null&&n[e]?Object.assign(h.value[e],{...h.value[e],...s}):await p()};return{fields:t,loadViewColumns:p,filteredFieldList:z,filterQuery:A,showAll:N,hideAll:P,saveOrUpdate:y,sortedAndFilteredFields:G,showSystemFields:O,metaColumnById:o,toggleFieldVisibility:H,isViewColumnsLoading:x,updateGridViewColumn:L,gridViewCols:h,resizingColOldWith:R}},"useViewColumnsOrThrow");function ie(){const u=D();if(u==null)throw new Error("Please call `useProvideViewColumns` on the appropriate parent component");return u}export{le as a,ie as u};
